<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Aseguramiento (Cloud)</title>
    <!-- 
      Usamos Tailwind CSS para un diseño moderno y responsivo.
      También incluimos las librerías para generar el PDF (jsPDF y jsPDF-AutoTable).
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Importar Fuente Estilizada (Dancing Script) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

    <style>
        /* Estilos adicionales para un mejor aspecto */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Clase para la nueva fuente del título */
        .font-dancing-script {
            font-family: 'Dancing Script', cursive;
        }

        /* Estilo para los inputs de número sin flechas */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Estilo para los selects */
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65em auto;
            padding-right: 2.5rem;
        }
        /* Ocultar botones de gestión por defecto */
        .gestion-btn {
            display: none;
        }
        /* Estilo para la vista previa del sello (crossorigin para Firebase Storage) */
        #selloPreview {
            border: 1px dashed #ddd;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <!-- CONTENEDOR DE LOGIN -->
    <div id="login-container" class="max-w-md mx-auto bg-white shadow-lg rounded-lg p-8 text-center mt-20">
        <h1 class="text-3xl font-bold text-purple-700 mb-6 font-dancing-script">Informe de Aseguramiento</h1>
        
        <!-- Contenedor de estado de Login -->
        <div id="login-status">
            <p class="text-gray-600 mb-8">Por favor, inicia sesión para continuar.</p>
    
            <!-- Botón de Login con Google (Lila) -->
            <button id="google-login-btn" class="bg-purple-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-purple-600 hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 ease-in-out flex items-center justify-center w-full">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFF" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FFC107" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#FF3D00" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.027C9.505,39.556,16.227,44,24,44z"></path><path fill="#4CAF50" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C39.099,34.799,44,28,44,20C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Iniciar Sesión con Google
            </button>
        </div>

        <!-- Estado de Carga (Oculto por defecto para que no bloquee el login en Vercel) -->
        <div id="loading-container" class="hidden">
            <p class="text-gray-600 mb-4">Verificando autenticación...</p>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-700 mx-auto"></div>
        </div>

    </div>

    <!-- APLICACIÓN (Oculta por defecto) -->
    <div id="app-container" class="container max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden hidden">
        
        <!-- Encabezado -->
        <div class="bg-purple-700 p-6 flex justify-between items-center flex-wrap">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white flex items-center font-dancing-script mb-2 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    Informe de Aseguramiento
                </h1>
                <p id="user-info" class="text-purple-200 text-xs font-medium mt-1 ml-11"></p>
            </div>
            <button id="logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-full shadow-md hover:bg-red-600 transition text-sm font-semibold">
                Cerrar Sesión
            </button>
        </div>

        <!-- Botón Limpiar Formulario -->
        <div class="p-6 md:p-8 pb-0 flex justify-end">
            <button type="button" id="clearFormBtn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15m0 0l6.75-6.75M4.5 12l6.75 6.75" />
                </svg>
                Limpiar Formulario
            </button>
        </div>

        <!-- Formulario -->
        <form id="report-form" class="p-6 md:p-8 pt-6 space-y-6">

            <!-- Sección Contador -->
            <div class="form-group">
                <label for="selectContador" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <select id="selectContador" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                    <option value="">-- Selecciona Contador Guardado --</option>
                </select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    Datos del Contador
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="contadorNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Contador</label>
                        <input type="text" id="contadorNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="contadorRif" class="block text-sm font-medium text-gray-700 mb-1">RIF del Contador</label>
                        <input type="text" id="contadorRif" placeholder="Ej: V-12345678-9" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="form-group">
                        <label for="contadorCpc" class="block text-sm font-medium text-gray-700 mb-1">Núm. C.P.C.</label>
                        <input type="text" id="contadorCpc" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <label for="contadorSello" class="block text-sm font-medium text-gray-700 mb-1">Sello del Contador (PNG)</label>
                    <input type="file" id="contadorSello" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-purple-50 file:text-purple-700
                        hover:file:bg-purple-100" accept="image/png">
                    <small class="text-xs text-gray-500">Subir PNG. Máx: 5.30cm (ancho) x 2.10cm (alto).</small>
                    <img id="selloPreview" src="" alt="Vista previa del sello" class="mt-2 h-16 object-contain hidden p-2" crossorigin="anonymous" />
                </div>
                
                <div class="text-right mt-4 space-x-2">
                    <button type="button" id="deleteContadorBtn" class="btn-danger gestion-btn" title="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="updateContadorBtn" class="btn-warning gestion-btn" title="Actualizar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="saveContadorBtn" class="btn-save" title="Guardar como Nuevo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                    </button>
                </div>
            </fieldset>

            <!-- Sección Cliente -->
             <div class="form-group">
                <label for="selectCliente" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <select id="selectCliente" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                    <option value="">-- Selecciona Cliente Guardado --</option>
                </select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Datos del Cliente
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="clienteTratamiento" class="block text-sm font-medium text-gray-700 mb-1">Tratamiento</label>
                        <select id="clienteTratamiento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                            <option value="Sr.">Sr.</option>
                            <option value="Sra.">Sra.</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clienteNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                        <input type="text" id="clienteNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="clienteCedula" class="block text-sm font-medium text-gray-700 mb-1">N.º de Cédula</label>
                        <input type="text" id="clienteCedula" placeholder="Ej: V-12345678" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>
                 <div class="text-right mt-4 space-x-2">
                    <button type="button" id="deleteClienteBtn" class="btn-danger gestion-btn" title="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="updateClienteBtn" class="btn-warning gestion-btn" title="Actualizar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="saveClienteBtn" class="btn-save" title="Guardar como Nuevo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                    </button>
                </div>
            </fieldset>

            <!-- Sección Informe -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Datos del Informe
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="entidadDirigida" class="block text-sm font-medium text-gray-700 mb-1">Entidad a la que se dirige</label>
                        <input type="text" id="entidadDirigida" list="bancos-list" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="bancos-list">
                            <option value="Banco de Venezuela, S.A. Banco Universal"></option>
                            <option value="Banesco Banco Universal, C.A."></option>
                            <option value="Banco Provincial, S.A. Banco Universal"></option>
                            <option value="Banco Mercantil, C.A. Banco Universal"></option>
                            <option value="Bancaribe, C.A. Banco Universal"></option>
                            <option value="Banco Nacional de Crédito, C.A. Banco Universal"></option>
                            <option value="Banco Exterior, C.A. Banco Universal"></option>
                            <option value="Banco del Tesoro, C.A. Banco Universal"></option>
                            <option value="Bicentenario Banco Universal, C.A."></option>
                            <option value="100% Banco, Banco Universal"></option>
                            <option value="Banplus Banco Universal, C.A."></option>
                            <option value="Banca Amiga, C.A. Banco Universal"></option>
                            <option value="Mi Banco, C.A. Banco de Desarrollo"></option>
                            <option value="Banco Venezolano de Crédito, S.A. Banco Universal"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="motivoInforme" class="block text-sm font-medium text-gray-700 mb-1">Motivo del Informe</label>
                        <input type="text" id="motivoInforme" list="motivos-list" placeholder="Ej: Solicitud de crédito" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="motivos-list">
                            <option value="Solicitud de crédito"></option>
                            <option value="Apertura de la Cuenta Bancaria"></option>
                            <option value="Actualización de datos"></option>
                            <option value="Trámite de visa"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="lugar" class="block text-sm font-medium text-gray-700 mb-1">Lugar</label>
                        <input type="text" id="lugar" list="ciudades-list" placeholder="Ej: Barquisimeto" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="ciudades-list">
                            <option value="Caracas"></option>
                            <option value="Maracaibo"></option>
                            <option value="Valencia"></option>
                            <option value="Barquisimeto"></option>
                            <option value="Maracay"></option>
                            <option value-"Ciudad Guayana"></option>
                            <option value="San Cristóbal"></option>
                            <option value="Mérida"></option>
                            <option value="Barcelona"></option>
                            <option value="Cumaná"></option>
                            <option value="Maturín"></option>
                            <option value="Porlamar"></option>
                            <option value="Barinas"></option>
                            <option value="Coro"></option>
                            <option value="San Felipe"></option>
                            <option value="San Juan de los Morros"></option>
                            <option value="Quibor"></option>
                            <option value="El Tocuyo"></option>
                            <option value="Sanare"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="fechaDocumento" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Documento</label>
                        <input type="date" id="fechaDocumento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaDesde" class="block text-sm font-medium text-gray-700 mb-1">Período - Desde</label>
                        <input type="date" id="fechaDesde" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaHasta" class="block text-sm font-medium text-gray-700 mb-1">Período - Hasta</label>
                        <input type="date" id="fechaHasta" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>
            </fieldset>

            <!-- Sección Ingresos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Detalle de los Ingresos del Período
                </legend>
                <datalist id="conceptos-list"></datalist>
                <div id="income-details" class="space-y-3 mb-4"></div>
                <button type="button" id="addIncomeBtn" class="btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Agregar Concepto
                </button>
            </fieldset>

            <!-- Sección Gestionar Conceptos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Gestionar Conceptos de Ingreso
                </legend>
                <div class="space-y-4">
                    <div>
                        <select id="conceptosSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50"></select>
                    </div>
                    <div>
                        <input type="text" id="conceptoEditInput" placeholder="Nuevo concepto o editar seleccionado" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" id="conceptoBtnAgregar" class="btn-save" title="Agregar Nuevo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnEditar" class="btn-warning" title="Cargar para Editar">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnGuardarEdicion" class="btn-save hidden" title="Guardar Cambios">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnEliminar" class="btn-danger" title="Eliminar Seleccionado">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            </fieldset>

            <!-- Botones de Acción -->
            <div class="pt-6 border-t border-gray-200 flex justify-center">
                <button type="submit" id="generatePdfBtn" class="btn-primary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Generar PDF
                </button>
            </div>
        </form>
    </div>

    <div id="message-container" class="fixed top-5 right-5 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";
        
        // Configuración de Firebase: Usa la del entorno (vista previa) o la tuya por defecto (producción)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD4OAsKvRgr1Aq1lQ1mTwKtDznusPRTBKY",
            authDomain: "contabyt-b0549.firebaseapp.com",
            projectId: "contabyt-b0549",
            storageBucket: "contabyt-b0549.firebasestorage.app",
            messagingSenderId: "876182351779",
            appId: "1:876182351779:web:225a641ab72ca62ed03416",
            measurementId: "G-28153DWXGK"
        };

        // Variables específicas de Canvas para autenticación segura en vista previa
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        
        let currentUserId = null, localContadores = [], localClientes = [], conceptosGuardados = [], edicionConceptoIndex = null;
        let unsubContadores = () => {}, unsubClientes = () => {};
        
        // Referencias DOM
        const loginContainer = document.getElementById('login-container'), loginStatus = document.getElementById('login-status'), loadingContainer = document.getElementById('loading-container'), appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn'), logoutBtn = document.getElementById('logout-btn'), userInfo = document.getElementById('user-info');
        const selectContador = document.getElementById('selectContador'), selectCliente = document.getElementById('selectCliente'), contadorSelloInput = document.getElementById('contadorSello'), selloPreview = document.getElementById('selloPreview');
        const reportForm = document.getElementById('report-form'), clearFormBtn = document.getElementById('clearFormBtn'), addIncomeBtn = document.getElementById('addIncomeBtn');
        
        // Estilos
        const btnBaseClass = "py-2 px-3 text-sm font-semibold rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 inline-flex items-center justify-center";
        const btnIconBase = "p-2.5 font-semibold rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 inline-flex items-center justify-center";
        const btnIconLilac = `${btnIconBase} bg-purple-200 text-purple-800 hover:bg-purple-300 focus:ring-purple-400`;
        const btnSecondaryClass = `${btnBaseClass} bg-yellow-200 text-yellow-800 hover:bg-yellow-300 focus:ring-yellow-300`;
        const btnPrimaryClass = "w-full py-3 px-6 bg-purple-700 text-white font-bold rounded-full shadow-lg hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 flex items-center justify-center";
        const btnDangerClass = btnIconLilac, btnSaveClass = btnIconLilac, btnWarningClass = btnIconLilac;
        const btnClearClass = `${btnBaseClass} bg-yellow-200 text-yellow-800 hover:bg-yellow-300 focus:ring-yellow-300`;
        const btnSmallDangerClass = "p-1.5 bg-red-600 text-white rounded-full shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95";
        
        addIncomeBtn.className = btnSecondaryClass; document.getElementById('generatePdfBtn').className = btnPrimaryClass;
        document.getElementById('saveContadorBtn').className = btnSaveClass; document.getElementById('saveClienteBtn').className = btnSaveClass; clearFormBtn.className = btnClearClass;
        document.getElementById('deleteContadorBtn').className = btnDangerClass + " gestion-btn"; document.getElementById('updateContadorBtn').className = btnWarningClass + " gestion-btn";
        document.getElementById('deleteClienteBtn').className = btnDangerClass + " gestion-btn"; document.getElementById('updateClienteBtn').className = btnWarningClass + " gestion-btn";
        document.getElementById('conceptoBtnAgregar').className = btnSaveClass; document.getElementById('conceptoBtnEditar').className = btnWarningClass;
        document.getElementById('conceptoBtnGuardarEdicion').className = `${btnSaveClass} hidden`; document.getElementById('conceptoBtnEliminar').className = btnDangerClass;
        
        function showMessage(msg, type = 'success', duration = 3000) {
            const c = document.getElementById('message-container'), d = document.createElement('div');
            d.className = `p-4 ${type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500')} text-white rounded-lg shadow-lg mb-2 transition-all duration-300 ease-out transform translate-x-full`;
            d.textContent = msg; c.appendChild(d);
            setTimeout(() => { d.classList.remove('translate-x-full'); d.classList.add('translate-x-0'); }, 10);
            setTimeout(() => { d.classList.add('opacity-0', 'translate-x-full'); setTimeout(() => { if (c.contains(d)) c.removeChild(d); }, 500); }, duration);
        }

        function fileToDataUrl(file) { return new Promise((resolve, reject) => { const r = new FileReader(); r.onload = () => resolve(r.result); r.onerror = reject; r.readAsDataURL(file); }); }
        function getImageDimensions(url) { return new Promise((resolve, reject) => { const i = new Image(); i.onload = () => resolve({ width: i.width, height: i.height }); i.onerror = (e) => { console.error("Img err", e); reject(new Error('Err dimensiones.')); }; i.src = url; }); }

        function formatCedula(e) { let v = e.target.value.replace(/[^a-zA-Z0-9]/g, ''), l = (v.match(/^[VEve]/) || ['V'])[0].toUpperCase(), n = v.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, '').substring(0, 8); e.target.value = `${l}-${n.replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`; }
        function formatRif(e) { let v = e.target.value.replace(/[^a-zA-Z0-9]/g, ''), l = (v.match(/^[JGjgVEvePp]/) || ['V'])[0].toUpperCase(), n = v.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, ''), m = n.length > 8 ? n.substring(0, 8) : n, d = n.length > 8 ? '-' + n.substring(n.length - 1) : ''; e.target.value = `${l}-${m.replace(/\B(?=(\d{3})+(?!\d))/g, '.')}${d}`; }
        function formatSimpleThousands(e) { let v = e.target.value.replace(/[^\d]/g, ''); e.target.value = v ? new Intl.NumberFormat('es-VE').format(parseInt(v, 10)) : ''; }
        function formatCurrencyInput(e) { let v = e.target.value.replace(/[^\d,]/g, ''), p = v.split(','), i = p[0].replace(/\./g, ''); i = i ? new Intl.NumberFormat('es-VE').format(parseInt(i, 10)) : ''; e.target.value = p[1] !== undefined ? `${i || '0'},${p[1].substring(0, 2)}` : i; }
        function parseFormattedNumber(v) { return !v ? 0 : v.replace(/\./g, '').replace(',', '.'); }
        function formatDate(dStr, opts = {}) { if (!dStr) return ''; const d = new Date(dStr + 'T00:00:00'); if (opts.format === 'dd de M de yyyy') return `${String(d.getDate()).padStart(2, '0')} de ${["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"][d.getMonth()]} ${d.getFullYear()}`; return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; }
        function formatCurrency(n) { return new Intl.NumberFormat('es-VE', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n); }

        function clearFormContador() { document.getElementById('contadorNombre').value = ''; document.getElementById('contadorRif').value = ''; document.getElementById('contadorCpc').value = ''; contadorSelloInput.value = ''; selloPreview.src = ''; selloPreview.classList.add('hidden'); selectContador.value = ""; document.getElementById('deleteContadorBtn').style.display = 'none'; document.getElementById('updateContadorBtn').style.display = 'none'; }
        function clearFormCliente() { document.getElementById('clienteTratamiento').value = 'Sr.'; document.getElementById('clienteNombre').value = ''; document.getElementById('clienteCedula').value = ''; selectCliente.value = ""; document.getElementById('deleteClienteBtn').style.display = 'none'; document.getElementById('updateClienteBtn').style.display = 'none'; }
        function setFechasDefault() { const n = new Date(); document.getElementById('fechaDocumento').value = n.toISOString().split('T')[0]; document.getElementById('fechaDesde').value = new Date(n.getFullYear(), n.getMonth(), 1).toISOString().split('T')[0]; document.getElementById('fechaHasta').value = new Date(n.getFullYear(), n.getMonth() + 1, 0).toISOString().split('T')[0]; }
        function clearForm() { reportForm.reset(); document.getElementById('income-details').innerHTML = ''; addIncomeItem(); clearFormContador(); clearFormCliente(); setFechasDefault(); showMessage('Formulario limpiado.'); }

        function addIncomeItem() {
            const c = document.getElementById('income-details'), d = document.createElement('div');
            d.className = 'flex flex-col md:flex-row items-center gap-3 income-item';
            d.innerHTML = `<input type="text" placeholder="Concepto" class="w-full md:flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 income-concept" list="conceptos-list" required><input type="text" inputmode="decimal" placeholder="Monto (Bs.)" class="w-full md:w-32 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 income-amount" required>`;
            const b = document.createElement('button'); b.type = 'button'; b.className = btnSmallDangerClass + ' w-full md:w-auto'; b.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>'; b.onclick = () => c.removeChild(d);
            d.appendChild(b); c.appendChild(d); d.querySelector('.income-amount').addEventListener('input', formatCurrencyInput);
        }

        function loadDropdownsUI() {
            selectContador.innerHTML = '<option value="">-- Selecciona Contador Guardado --</option>'; localContadores.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = `${c.nombre} (CPC: ${c.cpc})`; selectContador.appendChild(o); });
            selectCliente.innerHTML = '<option value="">-- Selecciona Cliente Guardado --</option>'; localClientes.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = `${c.nombre} (CI: ${c.cedula})`; selectCliente.appendChild(o); });
        }
        function fillContadorForm(id) { clearFormContador(); selectContador.value = id; if (!id) return; const c = localContadores.find(x => x.id === id); if (c) { document.getElementById('contadorNombre').value = c.nombre || ''; document.getElementById('contadorRif').value = c.rif || ''; document.getElementById('contadorCpc').value = c.cpc || ''; if (c.selloURL) { selloPreview.src = c.selloURL; selloPreview.classList.remove('hidden'); } document.getElementById('deleteContadorBtn').style.display = 'inline-block'; document.getElementById('updateContadorBtn').style.display = 'inline-block'; } }
        function fillClienteForm(id) { clearFormCliente(); selectCliente.value = id; if (!id) return; const c = localClientes.find(x => x.id === id); if (c) { document.getElementById('clienteTratamiento').value = c.tratamiento || 'Sr.'; document.getElementById('clienteNombre').value = c.nombre || ''; document.getElementById('clienteCedula').value = c.cedula || ''; document.getElementById('deleteClienteBtn').style.display = 'inline-block'; document.getElementById('updateClienteBtn').style.display = 'inline-block'; } }

        // Usar rutas PÚBLICAS para datos compartidos (solución de permisos)
        function getPublicCol(n) { return collection(db, 'artifacts', appId, 'public', 'data', n); }
        function getPublicDoc(n, id) { return doc(db, 'artifacts', appId, 'public', 'data', n, id); }

        async function handleSaveContador() { if (!currentUserId) return showMessage('Inicie sesión.', 'error'); const n = document.getElementById('contadorNombre').value.trim(), r = document.getElementById('contadorRif').value.trim(), c = document.getElementById('contadorCpc').value.trim(); if (!n || !c) return showMessage('Faltan datos.', 'error'); if (localContadores.some(x => x.cpc === c)) return showMessage('CPC duplicado.', 'error'); showMessage('Guardando...', 'info'); try { const refDoc = await addDoc(getPublicCol('contadores'), { nombre: n, rif: r, cpc: c, userId: currentUserId }); if (contadorSelloInput.files[0]) { const sRef = ref(storage, `artifacts/${appId}/public/sellos/${refDoc.id}.png`); await uploadBytes(sRef, contadorSelloInput.files[0]); await updateDoc(refDoc, { selloURL: await getDownloadURL(sRef) }); } showMessage('Guardado.', 'success'); clearFormContador(); } catch (e) { console.error(e); showMessage('Error: ' + e.message, 'error'); } }
        async function handleUpdateContador() { const id = selectContador.value; if (!id || !currentUserId) return; const n = document.getElementById('contadorNombre').value.trim(), r = document.getElementById('contadorRif').value.trim(), c = document.getElementById('contadorCpc').value.trim(); if (localContadores.some(x => x.cpc === c && x.id !== id)) return showMessage('CPC duplicado.', 'error'); showMessage('Actualizando...', 'info'); try { const dRef = getPublicDoc('contadores', id), data = { nombre: n, rif: r, cpc: c }; if (contadorSelloInput.files[0]) { const sRef = ref(storage, `artifacts/${appId}/public/sellos/${id}.png`); await uploadBytes(sRef, contadorSelloInput.files[0]); data.selloURL = await getDownloadURL(sRef); } await setDoc(dRef, data, { merge: true }); showMessage('Actualizado.', 'success'); const upd = { ...localContadores.find(x => x.id === id), ...data }; fillContadorForm(id); selectContador.value = id; document.getElementById('contadorNombre').value = upd.nombre; document.getElementById('contadorRif').value = upd.rif; document.getElementById('contadorCpc').value = upd.cpc; if (upd.selloURL) { selloPreview.src = upd.selloURL; selloPreview.classList.remove('hidden'); } } catch (e) { console.error(e); showMessage('Error: ' + e.message, 'error'); } }
        async function handleDeleteContador() { const id = selectContador.value; if (!id || !currentUserId || !confirm('¿Eliminar?')) return; try { await deleteDoc(getPublicDoc('contadores', id)); try { await deleteObject(ref(storage, `artifacts/${appId}/public/sellos/${id}.png`)); } catch (e) {} showMessage('Eliminado.', 'success'); clearFormContador(); } catch (e) { console.error(e); showMessage('Error: ' + e.message, 'error'); } }
        async function handleSaveCliente() { if (!currentUserId) return showMessage('Inicie sesión.', 'error'); const t = document.getElementById('clienteTratamiento').value, n = document.getElementById('clienteNombre').value.trim(), c = document.getElementById('clienteCedula').value.trim(); if (!n || !c) return showMessage('Faltan datos.', 'error'); if (localClientes.some(x => x.cedula === c)) return showMessage('Cédula duplicada.', 'error'); try { await addDoc(getPublicCol('clientes'), { tratamiento: t, nombre: n, cedula: c, userId: currentUserId }); showMessage('Guardado.', 'success'); clearFormCliente(); } catch (e) { console.error(e); showMessage('Error.', 'error'); } }
        async function handleUpdateCliente() { const id = selectCliente.value; if (!id || !currentUserId) return; const t = document.getElementById('clienteTratamiento').value, n = document.getElementById('clienteNombre').value.trim(), c = document.getElementById('clienteCedula').value.trim(); if (localClientes.some(x => x.cedula === c && x.id !== id)) return showMessage('Cédula duplicada.', 'error'); try { await updateDoc(getPublicDoc('clientes', id), { tratamiento: t, nombre: n, cedula: c }); showMessage('Actualizado.', 'success'); } catch (e) { console.error(e); showMessage('Error.', 'error'); } }
        async function handleDeleteCliente() { const id = selectCliente.value; if (!id || !currentUserId || !confirm('¿Eliminar?')) return; try { await deleteDoc(getPublicDoc('clientes', id)); showMessage('Eliminado.', 'success'); clearFormCliente(); } catch (e) { console.error(e); showMessage('Error.', 'error'); } }

        const conceptosDefault = ["Actividades Comerciales", "Honorarios profesionales libre ejercicio", "Alquiler de inmueble"];
        async function loadConceptos() { try { const s = await getDoc(getPublicDoc('config', 'conceptos_main')); conceptosGuardados = (s.exists() && s.data().lista) ? s.data().lista : [...conceptosDefault]; if (!s.exists()) await setDoc(getPublicDoc('config', 'conceptos_main'), { lista: conceptosGuardados }); updateConceptosUI(); } catch (e) { console.error(e); conceptosGuardados = [...conceptosDefault]; updateConceptosUI(); } }
        function updateConceptosUI() { const s = document.getElementById('conceptosSelect'), l = document.getElementById('conceptos-list'); s.innerHTML = ''; l.innerHTML = ''; conceptosGuardados.forEach((c, i) => { const o = document.createElement('option'); o.value = i; o.textContent = c; s.appendChild(o); const lo = document.createElement('option'); lo.value = c; l.appendChild(lo); }); document.getElementById('conceptoEditInput').value = ''; document.getElementById('conceptoBtnAgregar').style.display = 'inline-flex'; document.getElementById('conceptoBtnGuardarEdicion').style.display = 'none'; edicionConceptoIndex = null; }
        async function saveConceptos() { if (!currentUserId) return showMessage('Inicie sesión.', 'error'); try { await updateDoc(getPublicDoc('config', 'conceptos_main'), { lista: conceptosGuardados }); updateConceptosUI(); return true; } catch (e) { console.error(e); showMessage('Error al guardar conceptos.', 'error'); return false; } }

        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const items = document.querySelectorAll('.income-item'); if (items.length === 0) return showMessage('Agregue ingresos.', 'error');
            let v = true; items.forEach(i => { if (!i.querySelector('.income-concept').value || parseFloat(parseFormattedNumber(i.querySelector('.income-amount').value)) <= 0) v = false; });
            if (!v) return showMessage('Revise montos.', 'error'); showMessage('Generando PDF...', 'info', 10000); document.getElementById('generatePdfBtn').disabled = true;
            try {
                let sUrl = null, w = 0, h = 0, file = contadorSelloInput.files[0], img = document.getElementById('selloPreview');
                if (file) { sUrl = await fileToDataUrl(file); const d = await getImageDimensions(sUrl); w = d.width; h = d.height; }
                else if (img.src && img.complete && img.naturalWidth > 0) {
                    if (img.src.startsWith('data:')) { sUrl = img.src; const d = await getImageDimensions(sUrl); w = d.width; h = d.height; }
                    else { const c = document.createElement('canvas'); c.width = img.naturalWidth; c.height = img.naturalHeight; c.getContext('2d').drawImage(img, 0, 0); sUrl = c.toDataURL('image/png'); w = img.naturalWidth; h = img.naturalHeight; }
                }
                buildPDF(sUrl, w, h); showMessage('PDF generado.', 'success');
            } catch (e) { console.error(e); showMessage('Error PDF: ' + e.message, 'error'); } finally { document.getElementById('generatePdfBtn').disabled = false; }
        });

        function buildPDF(sUrl, sW, sH) {
            const doc = new window.jspdf.jsPDF('p', 'pt', 'letter'), val = id => document.getElementById(id).value;
            const [cNom, cCpc, cRif, cliTrat, cliNom, cliCed, ent, mot, lug, fDoc, fDes, fHas] = ['contadorNombre', 'contadorCpc', 'contadorRif', 'clienteTratamiento', 'clienteNombre', 'clienteCedula', 'entidadDirigida', 'motivoInforme', 'lugar', 'fechaDocumento', 'fechaDesde', 'fechaHasta'].map(val);
            const fDocL = `${lug}, ${formatDate(fDoc, { format: 'dd de M de yyyy' })}`, fDesL = formatDate(fDes, { format: 'dd de M de yyyy' }), fHasL = formatDate(fHas, { format: 'dd de M de yyyy' });
            let tot = 0, rows = []; document.querySelectorAll('.income-item').forEach(i => { const m = parseFloat(parseFormattedNumber(i.querySelector('.income-amount').value)) || 0; if (m > 0) { rows.push([i.querySelector('.income-concept').value, `Bs. ${formatCurrency(m)}`]); tot += m; } });
            const m = 60, pW = doc.internal.pageSize.getWidth(), uW = pW - m * 2; let y = 140;
            doc.setFont('helvetica', 'normal');
            const txt = (t, o = {}) => { doc.setFontSize(o.sz || 11); doc.setFont('helvetica', o.st || 'normal'); const h = doc.splitTextToSize(t, uW - (o.ind || 0)).length * (o.sz || 11) * 1.15; if (y + h > doc.internal.pageSize.getHeight() - 85) { doc.addPage(); y = 140; } doc.text(t, o.al === 'center' ? pW / 2 : (o.al === 'right' ? pW - m : m + (o.ind || 0)), y, { align: o.al || 'justify', maxWidth: uW - (o.ind || 0) }); y += h + (o.sp || 15); };
            txt('INFORME DE ENCARGOS DE ASEGURAMIENTO DEL CONTADOR PÚBLICO INDEPENDIENTE', { st: 'bold', al: 'center', sp: 30 }); txt('Alcance', { st: 'bold', al: 'left', sp: 15 }); txt(`He revisado la evidencia inherente a los ingresos percibidos por el ${cliTrat} ${cliNom}, con cedula de identidad N.º ${cliCed}, durante el periodo comprendido desde el ${formatDate(fDes)} hasta el ${formatDate(fHas)}, presentado en la relación de ingresos adjunta.`, { ind: 20, sp: 20 }); txt('Responsabilidad de la persona que percibe los ingresos', { st: 'bold', al: 'left', sp: 15 }); txt(`El ${cliTrat} ${cliNom}, es responsable de la preparación y presentación del importe de sus ingresos, incluyendo la integridad, legalidad y veracidad de los documentos suministrados.`, { ind: 20, sp: 20 }); txt('Responsabilidad del Contador Público Independiente', { st: 'bold', al: 'left', sp: 15 }); txt(`Mi responsabilidad es expresar una opinión sobre la relación de ingresos obtenida por el ${cliTrat} ${cliNom}, durante el periodo señalado de acuerdo con mis procedimientos, realizados de conformidad con la Norma Internacional de Encargos de Aseguramiento NIEA 3000.`, { ind: 20, sp: 15 });
            doc.addPage(); y = 140; txt('Opinión', { st: 'bold', al: 'left', sp: 15 }); txt('Con base en el trabajo efectuado descrito en este informe, no ha llamado mi atención algo que me haga pensar que la relación de ingresos que se anexa, en todos los aspectos importantes, no sea razonable.', { ind: 20, sp: 25 }); txt('Usuarios Previstos y Propósitos', { st: 'bold', al: 'left', sp: 15 }); txt(`Este informe está dirigido únicamente al ${ent} el cual lo ha requerido para ${mot}.`, { ind: 20, sp: 40 });
            let sigH = 60; if (cRif) sigH += 15; if (y + sigH + 40 > doc.internal.pageSize.getHeight() - 85) { doc.addPage(); y = 140; }
            const sigY = doc.internal.pageSize.getHeight() - 85 - sigH - 30; if (sUrl && sW > 0 && sH > 0) { const r = Math.min((5.3 * 28.35) / sW, (2.1 * 28.35) / sH, 1); doc.addImage(sUrl, 'PNG', pW - m - (sW * r), sigY - (sH * r), sW * r, sH * r); }
            y = doc.internal.pageSize.getHeight() - 85 - sigH - 15; txt(fDocL, { al: 'left', sp: 30 }); txt('________________________________', { al: 'center', sp: 12 }); txt(cNom, { st: 'bold', al: 'center', sp: 12 }); txt(`Contador Público C.P.C. N ${cCpc}`, { al: 'center', sp: 12 }); if (cRif) txt(`Rif: ${cRif}`, { al: 'center', sp: 12 });
            doc.addPage(); y = 140; txt(cliNom.toUpperCase(), { st: 'bold', al: 'center', sp: 10 }); txt(cliCed, { st: 'bold', al: 'center', sp: 30 }); txt('RELACIÓN DE INGRESOS (BS)', { st: 'bold', al: 'center', sp: 20 }); txt(`Correspondientes al período desde el ${fDesL} hasta el ${fHasL}:`, { sp: 20 });
            doc.autoTable({ head: [['Concepto', 'Monto (Bs.)']], body: rows, foot: [['Total Ingresos', `Bs. ${formatCurrency(tot)}`]], startY: y, margin: { left: m, right: m }, theme: 'grid', headStyles: { fillColor: [220, 220, 255], textColor: 20, halign: 'center', fontStyle: 'bold' }, columnStyles: { 0: { halign: 'left' }, 1: { halign: 'right' } }, didDrawPage: (d) => y = d.cursor.y }); y = doc.lastAutoTable.finalY + 40;
            txt('_____________________________________', { al: 'center', sp: 12 }); txt(cliNom, { st: 'bold', al: 'center', sp: 12 }); txt(`C.I. ${cliCed}`, { al: 'center', sp: 12 });
            doc.save(`Informe_${cliNom.replace(/\s+/g, '_')}.pdf`);
        }

        // --- INICIALIZACIÓN "HÍBRIDA" ---
        async function init() {
            // Por defecto (Producción): mostrar botón de login, ocultar loader
            loginStatus.classList.remove('hidden');
            loadingContainer.classList.add('hidden');

            onAuthStateChanged(auth, (user) => {
                currentUserId = user ? user.uid : null;
                loginContainer.classList.toggle('hidden', !!user);
                appContainer.classList.toggle('hidden', !user);
                userInfo.textContent = user ? (user.isAnonymous ? 'Sesión Anónima (Preview)' : (user.displayName || user.email)) : '';
                
                if (user) {
                    // Usuario autenticado: cargar datos desde rutas PÚBLICAS
                    unsubContadores(); unsubClientes();
                    unsubContadores = onSnapshot(getPublicCol('contadores'), (s) => { localContadores = s.docs.map(d => ({ id: d.id, ...d.data() })); loadDropdownsUI(); if (selectContador.value && !localContadores.find(x => x.id === selectContador.value)) clearFormContador(); });
                    unsubClientes = onSnapshot(getPublicCol('clientes'), (s) => { localClientes = s.docs.map(d => ({ id: d.id, ...d.data() })); loadDropdownsUI(); if (selectCliente.value && !localClientes.find(x => x.id === selectCliente.value)) clearFormCliente(); });
                    loadConceptos(); addIncomeItem(); setFechasDefault();
                } else {
                    // No autenticado: limpiar y asegurar que se ve el botón de login
                    unsubContadores(); unsubClientes(); clearForm();
                    loginStatus.classList.remove('hidden');
                    loadingContainer.classList.add('hidden');
                }
            });

            // Lógica de Auto-Login SOLO para Canvas
            if (initialAuthToken) {
                 // Estamos en Canvas Preview -> Ocultar login, mostrar loader
                 console.log("Detectado entorno Canvas Preview. Usando token.");
                 loginStatus.classList.add('hidden');
                 loadingContainer.classList.remove('hidden');
                 try {
                     await signInWithCustomToken(auth, initialAuthToken);
                 } catch (e) {
                     console.error("Fallo auto-login Canvas:", e);
                     // Si falla, volver a mostrar el botón de login normal
                     loginStatus.classList.remove('hidden');
                     loadingContainer.classList.add('hidden');
                 }
            }
        }

        // Event Listeners
        googleLoginBtn.addEventListener('click', async () => {
            loginStatus.classList.add('hidden'); loadingContainer.classList.remove('hidden');
            try {
                await signInWithPopup(auth, provider);
            } catch (e) {
                console.error("Error Google Login:", e);
                if (e.code === 'auth/unauthorized-domain') {
                    showMessage('Dominio no autorizado en Firebase. Revise la consola de Firebase.', 'error', 5000);
                } else {
                    showMessage('Error de inicio de sesión: ' + e.message, 'error');
                }
                loginStatus.classList.remove('hidden'); loadingContainer.classList.add('hidden');
            }
        });
        logoutBtn.addEventListener('click', () => signOut(auth)); clearFormBtn.addEventListener('click', clearForm); addIncomeBtn.addEventListener('click', addIncomeItem);
        document.getElementById('clienteCedula').addEventListener('input', formatCedula); document.getElementById('contadorRif').addEventListener('input', formatRif); document.getElementById('contadorCpc').addEventListener('input', formatSimpleThousands);
        selectContador.addEventListener('change', (e) => fillContadorForm(e.target.value)); selectCliente.addEventListener('change', (e) => fillClienteForm(e.target.value));
        document.getElementById('saveContadorBtn').addEventListener('click', handleSaveContador); document.getElementById('updateContadorBtn').addEventListener('click', handleUpdateContador); document.getElementById('deleteContadorBtn').addEventListener('click', handleDeleteContador);
        document.getElementById('saveClienteBtn').addEventListener('click', handleSaveCliente); document.getElementById('updateClienteBtn').addEventListener('click', handleUpdateCliente); document.getElementById('deleteClienteBtn').addEventListener('click', handleDeleteCliente);
        contadorSelloInput.addEventListener('change', function() { if (this.files[0]) { const r = new FileReader(); r.onload = (e) => { selloPreview.src = e.target.result; selloPreview.classList.remove('hidden'); }; r.readAsDataURL(this.files[0]); } });
        document.getElementById('conceptoBtnAgregar').addEventListener('click', () => { const v = document.getElementById('conceptoEditInput').value.trim(); if (v && !conceptosGuardados.includes(v)) { conceptosGuardados.push(v); saveConceptos(); } });
        document.getElementById('conceptoBtnEditar').addEventListener('click', () => { const i = document.getElementById('conceptosSelect').value; if (i !== "") { document.getElementById('conceptoEditInput').value = conceptosGuardados[i]; edicionConceptoIndex = i; document.getElementById('conceptoBtnAgregar').style.display = 'none'; document.getElementById('conceptoBtnGuardarEdicion').style.display = 'inline-flex'; } });
        document.getElementById('conceptoBtnGuardarEdicion').addEventListener('click', () => { const v = document.getElementById('conceptoEditInput').value.trim(); if (v && edicionConceptoIndex !== null) { conceptosGuardados[edicionConceptoIndex] = v; saveConceptos(); } });
        document.getElementById('conceptoBtnEliminar').addEventListener('click', () => { const i = document.getElementById('conceptosSelect').value; if (i !== "") { conceptosGuardados.splice(i, 1); saveConceptos(); } });

        // Iniciar
        init();
    </script>
</body>
</html>
