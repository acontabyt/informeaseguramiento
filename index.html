<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Aseguramiento (Cloud)</title>
    <!-- 
      Usamos Tailwind CSS para un diseño moderno y responsivo.
      También incluimos las librerías para generar el PDF (jsPDF y jsPDF-AutoTable).
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Importar Fuente Estilizada (Dancing Script) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

    <style>
        /* Estilos adicionales para un mejor aspecto */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Clase para la nueva fuente del título */
        .font-dancing-script {
            font-family: 'Dancing Script', cursive;
        }

        /* Estilo para los inputs de número sin flechas */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Estilo para los selects */
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65em auto;
            padding-right: 2.5rem;
        }
        /* Ocultar botones de gestión por defecto */
        .gestion-btn {
            display: none;
        }
        /* Estilo para la vista previa del sello (crossorigin para Firebase Storage) */
        #selloPreview {
            border: 1px dashed #ddd;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <!-- CONTENEDOR DE LOGIN -->
    <div id="login-container" class="max-w-md mx-auto bg-white shadow-lg rounded-lg p-8 text-center mt-20">
        <h1 class="text-3xl font-bold text-purple-700 mb-6 font-dancing-script">Informe de Aseguramiento</h1>
        
        <!-- Contenedor de estado de Login -->
        <div id="login-status">
            <p class="text-gray-600 mb-8">Iniciando sesión...</p>
            <!-- El botón se mostrará solo si falla el inicio automático -->
            <button id="google-login-btn" class="hidden bg-purple-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-purple-600 hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 ease-in-out items-center justify-center w-full">
                 <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
                Reintentar Inicio de Sesión
            </button>
        </div>

        <!-- Estado de Carga -->
        <div id="loading-container">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-700 mx-auto"></div>
        </div>

    </div>

    <!-- APLICACIÓN (Oculta por defecto) -->
    <div id="app-container" class="container max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden hidden">
        
        <!-- Encabezado -->
        <div class="bg-purple-700 p-6 flex justify-between items-center flex-wrap">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white flex items-center font-dancing-script mb-2 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    Informe de Aseguramiento
                </h1>
                <!-- Info del Usuario (NUEVO) -->
                <p id="user-info" class="text-purple-200 text-xs font-medium mt-1 ml-11"></p>
            </div>
            <!-- Botón de Logout -->
            <button id="logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-full shadow-md hover:bg-red-600 transition text-sm font-semibold">
                Cerrar Sesión
            </button>
        </div>

        <!-- Botón Limpiar Formulario -->
        <div class="p-6 md:p-8 pb-0 flex justify-end">
            <button type="button" id="clearFormBtn"> <!-- La clase se aplica por JS -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15m0 0l6.75-6.75M4.5 12l6.75 6.75" />
                </svg>
                Limpiar Formulario
            </button>
        </div>

        <!-- Formulario -->
        <form id="report-form" class="p-6 md:p-8 pt-6 space-y-6">

            <!-- Sección Contador -->
            <div class="form-group">
                <label for="selectContador" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <select id="selectContador" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                    <option value="">-- Selecciona Contador Guardado --</option>
                </select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    Datos del Contador
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="contadorNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Contador</label>
                        <input type="text" id="contadorNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="contadorRif" class="block text-sm font-medium text-gray-700 mb-1">RIF del Contador</label>
                        <input type="text" id="contadorRif" placeholder="Ej: V-12345678-9" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="form-group">
                        <label for="contadorCpc" class="block text-sm font-medium text-gray-700 mb-1">Núm. C.P.C.</label>
                        <input type="text" id="contadorCpc" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>

                <!-- Campo Sello del Contador (MODIFICADO) -->
                <div class="form-group mt-4">
                    <label for="contadorSello" class="block text-sm font-medium text-gray-700 mb-1">Sello del Contador (PNG)</label>
                    <input type="file" id="contadorSello" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-purple-50 file:text-purple-700
                        hover:file:bg-purple-100" accept="image/png">
                    <small class="text-xs text-gray-500">Subir PNG. Máx: 5.30cm (ancho) x 2.10cm (alto).</small>
                    
                    <!-- Vista previa del sello (MODIFICADA para crossOrigin) -->
                    <img id="selloPreview" src="" alt="Vista previa del sello" class="mt-2 h-16 object-contain hidden p-2" crossorigin="anonymous" />
                </div>
                
                <div class="text-right mt-4 space-x-2">
                    <button type="button" id="deleteContadorBtn" class="btn-danger gestion-btn" title="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="updateContadorBtn" class="btn-warning gestion-btn" title="Actualizar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="saveContadorBtn" class="btn-save" title="Guardar como Nuevo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                    </button>
                </div>
            </fieldset>

            <!-- Sección Cliente -->
             <div class="form-group">
                <label for="selectCliente" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <select id="selectCliente" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                    <option value="">-- Selecciona Cliente Guardado --</option>
                </select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Datos del Cliente
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="clienteTratamiento" class="block text-sm font-medium text-gray-700 mb-1">Tratamiento</label>
                        <select id="clienteTratamiento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                            <option value="Sr.">Sr.</option>
                            <option value="Sra.">Sra.</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clienteNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                        <input type="text" id="clienteNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="clienteCedula" class="block text-sm font-medium text-gray-700 mb-1">N.º de Cédula</label>
                        <input type="text" id="clienteCedula" placeholder="Ej: V-12345678" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>
                 <div class="text-right mt-4 space-x-2">
                    <button type="button" id="deleteClienteBtn" class="btn-danger gestion-btn" title="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="updateClienteBtn" class="btn-warning gestion-btn" title="Actualizar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="saveClienteBtn" class="btn-save" title="Guardar como Nuevo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                    </button>
                </div>
            </fieldset>

            <!-- Sección Informe -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Datos del Informe
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="entidadDirigida" class="block text-sm font-medium text-gray-700 mb-1">Entidad a la que se dirige</label>
                        <input type="text" id="entidadDirigida" list="bancos-list" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="bancos-list">
                            <option value="Banco de Venezuela, S.A. Banco Universal"></option>
                            <option value="Banesco Banco Universal, C.A."></option>
                            <option value="Banco Provincial, S.A. Banco Universal"></option>
                            <option value="Banco Mercantil, C.A. Banco Universal"></option>
                            <option value="Bancaribe, C.A. Banco Universal"></option>
                            <option value="Banco Nacional de Crédito, C.A. Banco Universal"></option>
                            <option value="Banco Exterior, C.A. Banco Universal"></option>
                            <option value="Banco del Tesoro, C.A. Banco Universal"></option>
                            <option value="Bicentenario Banco Universal, C.A."></option>
                            <option value="100% Banco, Banco Universal"></option>
                            <option value="Banplus Banco Universal, C.A."></option>
                            <option value="Banca Amiga, C.A. Banco Universal"></option>
                            <option value="Mi Banco, C.A. Banco de Desarrollo"></option>
                            <option value="Banco Venezolano de Crédito, S.A. Banco Universal"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="motivoInforme" class="block text-sm font-medium text-gray-700 mb-1">Motivo del Informe</label>
                        <input type="text" id="motivoInforme" list="motivos-list" placeholder="Ej: Solicitud de crédito" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="motivos-list">
                            <option value="Solicitud de crédito"></option>
                            <option value="Apertura de la Cuenta Bancaria"></option>
                            <option value="Actualización de datos"></option>
                            <option value="Trámite de visa"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="lugar" class="block text-sm font-medium text-gray-700 mb-1">Lugar</label>
                        <input type="text" id="lugar" list="ciudades-list" placeholder="Ej: Barquisimeto" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="ciudades-list">
                            <option value="Caracas"></option>
                            <option value="Maracaibo"></option>
                            <option value="Valencia"></option>
                            <option value="Barquisimeto"></option>
                            <option value="Maracay"></option>
                            <option value-"Ciudad Guayana"></option>
                            <option value="San Cristóbal"></option>
                            <option value="Mérida"></option>
                            <option value="Barcelona"></option>
                            <option value="Cumaná"></option>
                            <option value="Maturín"></option>
                            <option value="Porlamar"></option>
                            <option value="Barinas"></option>
                            <option value="Coro"></option>
                            <option value="San Felipe"></option>
                            <option value="San Juan de los Morros"></option>
                            <option value="Quibor"></option>
                            <option value="El Tocuyo"></option>
                            <option value="Sanare"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="fechaDocumento" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Documento</label>
                        <input type="date" id="fechaDocumento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaDesde" class="block text-sm font-medium text-gray-700 mb-1">Período - Desde</label>
                        <input type="date" id="fechaDesde" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaHasta" class="block text-sm font-medium text-gray-700 mb-1">Período - Hasta</label>
                        <input type="date" id="fechaHasta" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>
            </fieldset>

            <!-- Sección Ingresos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Detalle de los Ingresos del Período
                </legend>
                
                <datalist id="conceptos-list"></datalist>

                <div id="income-details" class="space-y-3 mb-4">
                    <!-- Los ingresos se agregarán aquí dinámicamente -->
                </div>
                <button type="button" id="addIncomeBtn" class="btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Agregar Concepto
                </button>
            </fieldset>

            <!-- Sección Gestionar Conceptos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Gestionar Conceptos de Ingreso (Guardados en tu cuenta)
                </legend>
                <div class="space-y-4">
                    <div>
                        <label for="conceptosSelect" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <select id="conceptosSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50"></select>
                    </div>
                    <div>
                        <label for="conceptoEditInput" class="block text-sm font-medium text-gray-700 mb-1">Concepto (para agregar o editar)</label>
                        <input type="text" id="conceptoEditInput" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" id="conceptoBtnAgregar" class="btn-save" title="Agregar Nuevo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnEditar" class="btn-warning" title="Cargar para Editar">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnGuardarEdicion" class="btn-save" style="display:none;" title="Guardar Cambios">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnEliminar" class="btn-danger" title="Eliminar Seleccionado">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            </fieldset>


            <!-- Botones de Acción -->
            <div class="pt-6 border-t border-gray-200 flex justify-center">
                <button type="submit" id="generatePdfBtn" class="btn-primary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Generar PDF
                </button>
            </div>
        </form>
    </div>

    <!-- Contenedor para mensajes de éxito/error -->
    <div id="message-container" class="fixed top-5 right-5 z-50"></div>

    <!-- 
    ================================================================
    SCRIPT DE APLICACIÓN Y AUTENTICACIÓN (TODO EN UN MÓDULO)
    ================================================================
    -->
    <script type="module">
        // --- SDK DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        // SDK de Firestore
        import {
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc,
            deleteDoc, onSnapshot, collection, query, writeBatch
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        // SDK de Storage
        import {
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";
        
        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
        // --- INICIALIZAR FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- VARIABLES GLOBALES DE ESTADO ---
        let currentUserId = null; 
        let localContadores = []; 
        let localClientes = []; 
        let conceptosGuardados = []; 
        let edicionConceptoIndex = null;
        let unsubContadores = () => {}; 
        let unsubClientes = () => {}; 
        
        // --- REFERENCIAS AL DOM ---
        const loginContainer = document.getElementById('login-container');
        const loginStatus = document.getElementById('login-status');
        const loadingContainer = document.getElementById('loading-container');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        
        const selectContador = document.getElementById('selectContador');
        const selectCliente = document.getElementById('selectCliente');
        const contadorSelloInput = document.getElementById('contadorSello');
        const selloPreview = document.getElementById('selloPreview');
        const reportForm = document.getElementById('report-form');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const addIncomeBtn = document.getElementById('addIncomeBtn');
        
        // Botones y Estilos
        const btnBaseClass = "py-2 px-3 text-sm font-semibold rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 inline-flex items-center justify-center";
        const btnIconBase = "p-2.5 font-semibold rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 inline-flex items-center justify-center";
        const btnIconLilac = `${btnIconBase} bg-purple-200 text-purple-800 hover:bg-purple-300 focus:ring-purple-400`;
        const btnSecondaryClass = `${btnBaseClass} bg-yellow-200 text-yellow-800 hover:bg-yellow-300 focus:ring-yellow-300`;
        const btnPrimaryClass = "w-full py-3 px-6 bg-purple-700 text-white font-bold rounded-full shadow-lg hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 flex items-center justify-center";
        const btnDangerClass = btnIconLilac;
        const btnSaveClass = btnIconLilac;
        const btnWarningClass = btnIconLilac;
        const btnClearClass = `${btnBaseClass} bg-yellow-200 text-yellow-800 hover:bg-yellow-300 focus:ring-yellow-300`;
        const btnSmallDangerClass = "p-1.5 bg-red-600 text-white rounded-full shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95";
        
        // Asignación de Estilos
        addIncomeBtn.className = btnSecondaryClass;
        document.getElementById('generatePdfBtn').className = btnPrimaryClass;
        document.getElementById('saveContadorBtn').className = btnSaveClass;
        document.getElementById('saveClienteBtn').className = btnSaveClass;
        clearFormBtn.className = btnClearClass;
        document.getElementById('deleteContadorBtn').className = btnDangerClass + " gestion-btn";
        document.getElementById('updateContadorBtn').className = btnWarningClass + " gestion-btn";
        document.getElementById('deleteClienteBtn').className = btnDangerClass + " gestion-btn";
        document.getElementById('updateClienteBtn').className = btnWarningClass + " gestion-btn";
        document.getElementById('conceptoBtnAgregar').className = btnSaveClass;
        document.getElementById('conceptoBtnEditar').className = btnWarningClass;
        document.getElementById('conceptoBtnGuardarEdicion').className = `${btnSaveClass} hidden`;
        document.getElementById('conceptoBtnEliminar').className = btnDangerClass;
        
        // --- FUNCIONES HELPER ---

        function showMessage(message, type = 'success', duration = 3000) {
            const container = document.getElementById('message-container');
            const msgDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            msgDiv.className = `p-4 ${bgColor} text-white rounded-lg shadow-lg mb-2 transition-all duration-300 ease-out transform translate-x-full`;
            msgDiv.textContent = message;
            container.appendChild(msgDiv);
            setTimeout(() => { msgDiv.classList.remove('translate-x-full'); msgDiv.classList.add('translate-x-0'); }, 10);
            setTimeout(() => {
                msgDiv.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => { if (container.contains(msgDiv)) container.removeChild(msgDiv); }, 500);
            }, duration);
        }

        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function getImageDimensions(dataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.width, height: img.height });
                img.onerror = (err) => { console.error("Error al cargar imagen", err); reject(new Error('Error al leer dimensiones.')); }
                img.src = dataUrl;
            });
        }

        // Funciones de formato
        function formatCedula(e) {
            let input = e.target.value.replace(/[^a-zA-Z0-9]/g, '');
            let letter = (input.match(/^[VEve]/) || ['V'])[0].toUpperCase();
            let numbers = input.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, '');
            if (numbers.length > 8) numbers = numbers.substring(0, 8);
            e.target.value = `${letter}-${numbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }
        function formatRif(e) {
            let input = e.target.value.replace(/[^a-zA-Z0-9]/g, '');
            let letter = (input.match(/^[JGjgVEvePp]/) || ['V'])[0].toUpperCase();
            let numbers = input.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, '');
            let main = numbers.length > 8 ? numbers.substring(0, 8) : numbers;
            let digit = numbers.length > 8 ? '-' + numbers.substring(numbers.length - 1) : '';
            e.target.value = `${letter}-${main.replace(/\B(?=(\d{3})+(?!\d))/g, '.')}${digit}`;
        }
        function formatSimpleThousands(e) {
            let val = e.target.value.replace(/[^\d]/g, '');
            if (!val) { e.target.value = ''; return; }
            e.target.value = new Intl.NumberFormat('es-VE').format(parseInt(val, 10));
        }
        function formatCurrencyInput(e) {
            let val = e.target.value.replace(/[^\d,]/g, '');
            let parts = val.split(',');
            let intPart = parts[0].replace(/\./g, '');
            intPart = intPart ? new Intl.NumberFormat('es-VE').format(parseInt(intPart, 10)) : '';
            e.target.value = parts[1] !== undefined ? `${intPart || '0'},${parts[1].substring(0, 2)}` : intPart;
        }
        function parseFormattedNumber(strVal) { return !strVal ? 0 : strVal.replace(/\./g, '').replace(',', '.'); }
        function formatDate(dateString, options = {}) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            if (options.format === 'dd de M de yyyy') {
                const months = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
                return `${day} de ${months[date.getMonth()]} ${year}`;
            }
            return `${day}/${month}/${year}`;
        }
        function formatCurrency(number) { return new Intl.NumberFormat('es-VE', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(number); }
        function calculateMonths(startDate, endDate) {
            const start = new Date(startDate); const end = new Date(endDate);
            let months = (end.getFullYear() - start.getFullYear()) * 12;
            months -= start.getMonth(); months += end.getMonth();
            if (end.getDate() < start.getDate()) months--;
            return months <= 0 ? 1 : months + 1;
        }

        // --- FUNCIONES DE LIMPIEZA ---
        function clearFormContador() {
            document.getElementById('contadorNombre').value = ''; document.getElementById('contadorRif').value = '';
            document.getElementById('contadorCpc').value = ''; contadorSelloInput.value = '';
            selloPreview.src = ''; selloPreview.classList.add('hidden'); selectContador.value = "";
            document.getElementById('deleteContadorBtn').style.display = 'none';
            document.getElementById('updateContadorBtn').style.display = 'none';
        }
        function clearFormCliente() {
            document.getElementById('clienteTratamiento').value = 'Sr.'; document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteCedula').value = ''; selectCliente.value = "";
            document.getElementById('deleteClienteBtn').style.display = 'none';
            document.getElementById('updateClienteBtn').style.display = 'none';
        }
        function setFechasDefault() {
            const now = new Date(); document.getElementById('fechaDocumento').value = now.toISOString().split('T')[0];
            document.getElementById('fechaDesde').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('fechaHasta').value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        }
        function clearForm() {
            reportForm.reset(); document.getElementById('income-details').innerHTML = ''; addIncomeItem();
            clearFormContador(); clearFormCliente(); setFechasDefault(); showMessage('Formulario limpiado.');
        }

        function addIncomeItem() {
            const container = document.getElementById('income-details');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex flex-col md:flex-row items-center gap-3 income-item';
            itemDiv.innerHTML = `
                <input type="text" placeholder="Concepto" class="w-full md:flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 income-concept" list="conceptos-list" required>
                <input type="text" inputmode="decimal" placeholder="Monto (Bs.)" class="w-full md:w-32 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 income-amount" required>
            `;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button'; removeBtn.className = btnSmallDangerClass + ' w-full md:w-auto';
            removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
            removeBtn.onclick = () => container.removeChild(itemDiv);
            itemDiv.appendChild(removeBtn); container.appendChild(itemDiv);
            itemDiv.querySelector('.income-amount').addEventListener('input', formatCurrencyInput);
        }

        // --- FUNCIONES DE DATOS Y FIRESTORE ---
        function loadDropdownsUI() {
            selectContador.innerHTML = '<option value="">-- Selecciona Contador Guardado --</option>';
            localContadores.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.textContent = `${c.nombre} (CPC: ${c.cpc})`; selectContador.appendChild(opt); });
            selectCliente.innerHTML = '<option value="">-- Selecciona Cliente Guardado --</option>';
            localClientes.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.textContent = `${c.nombre} (CI: ${c.cedula})`; selectCliente.appendChild(opt); });
        }
        function fillContadorForm(docId) {
            clearFormContador(); selectContador.value = docId; if (!docId) return;
            const cont = localContadores.find(c => c.id === docId);
            if (cont) {
                document.getElementById('contadorNombre').value = cont.nombre || ''; document.getElementById('contadorRif').value = cont.rif || '';
                document.getElementById('contadorCpc').value = cont.cpc || '';
                if (cont.selloURL) { selloPreview.src = cont.selloURL; selloPreview.classList.remove('hidden'); }
                document.getElementById('deleteContadorBtn').style.display = 'inline-block'; document.getElementById('updateContadorBtn').style.display = 'inline-block';
            }
        }
        function fillClienteForm(docId) {
            clearFormCliente(); selectCliente.value = docId; if (!docId) return;
            const cli = localClientes.find(c => c.id === docId);
            if (cli) {
                document.getElementById('clienteTratamiento').value = cli.tratamiento || 'Sr.'; document.getElementById('clienteNombre').value = cli.nombre || '';
                document.getElementById('clienteCedula').value = cli.cedula || '';
                document.getElementById('deleteClienteBtn').style.display = 'inline-block'; document.getElementById('updateClienteBtn').style.display = 'inline-block';
            }
        }

        // --- HELPERS PARA RUTAS PÚBLICAS (SOLUCIÓN DE PERMISOS) ---
        function getPublicCol(colName) { return collection(db, 'artifacts', appId, 'public', 'data', colName); }
        function getPublicDoc(colName, docId) { return doc(db, 'artifacts', appId, 'public', 'data', colName, docId); }

        async function handleSaveContador() {
            if (!currentUserId) return showMessage('Debe iniciar sesión.', 'error');
            const nombre = document.getElementById('contadorNombre').value.trim(), rif = document.getElementById('contadorRif').value.trim(), cpc = document.getElementById('contadorCpc').value.trim();
            if (!nombre || !cpc) return showMessage('Complete nombre y C.P.C.', 'error');
            if (localContadores.some(c => c.cpc === cpc)) return showMessage('C.P.C. ya existe.', 'error');
            showMessage('Guardando...', 'info');
            try {
                const docRef = await addDoc(getPublicCol('contadores'), { nombre, rif, cpc, userId: currentUserId });
                if (contadorSelloInput.files[0]) {
                    const storageRef = ref(storage, `artifacts/${appId}/public/sellos/${docRef.id}.png`);
                    await uploadBytes(storageRef, contadorSelloInput.files[0]);
                    await updateDoc(docRef, { selloURL: await getDownloadURL(storageRef) });
                }
                showMessage('Contador guardado.', 'success'); clearFormContador();
            } catch (e) { console.error(e); showMessage('Error al guardar: ' + e.message, 'error'); }
        }
        async function handleUpdateContador() {
            const docId = selectContador.value; if (!docId || !currentUserId) return;
            const nombre = document.getElementById('contadorNombre').value.trim(), rif = document.getElementById('contadorRif').value.trim(), cpc = document.getElementById('contadorCpc').value.trim();
            if (localContadores.some(c => c.cpc === cpc && c.id !== docId)) return showMessage('C.P.C. pertenece a otro.', 'error');
            showMessage('Actualizando...', 'info');
            try {
                const docRef = getPublicDoc('contadores', docId); const data = { nombre, rif, cpc };
                if (contadorSelloInput.files[0]) {
                    const storageRef = ref(storage, `artifacts/${appId}/public/sellos/${docId}.png`);
                    await uploadBytes(storageRef, contadorSelloInput.files[0]);
                    data.selloURL = await getDownloadURL(storageRef);
                }
                await setDoc(docRef, data, { merge: true });
                showMessage('Contador actualizado.', 'success');
                // Forzar recarga visual inmediata
                const updated = { ...localContadores.find(c => c.id === docId), ...data };
                fillContadorForm(docId);
                selectContador.value = docId;
                document.getElementById('contadorNombre').value = updated.nombre; document.getElementById('contadorRif').value = updated.rif; document.getElementById('contadorCpc').value = updated.cpc;
                if (updated.selloURL) { selloPreview.src = updated.selloURL; selloPreview.classList.remove('hidden'); }

            } catch (e) { console.error(e); showMessage('Error al actualizar: ' + e.message, 'error'); }
        }
        async function handleDeleteContador() {
            const docId = selectContador.value; if (!docId || !currentUserId) return;
            if (!confirm('¿Eliminar contador?')) return;
            try { await deleteDoc(getPublicDoc('contadores', docId)); showMessage('Eliminado.', 'success'); clearFormContador(); }
            catch (e) { console.error(e); showMessage('Error al eliminar.', 'error'); }
        }

        async function handleSaveCliente() {
            if (!currentUserId) return showMessage('Debe iniciar sesión.', 'error');
            const tratamiento = document.getElementById('clienteTratamiento').value, nombre = document.getElementById('clienteNombre').value.trim(), cedula = document.getElementById('clienteCedula').value.trim();
            if (!nombre || !cedula) return showMessage('Complete nombre y cédula.', 'error');
            if (localClientes.some(c => c.cedula === cedula)) return showMessage('Cédula ya existe.', 'error');
            try { await addDoc(getPublicCol('clientes'), { tratamiento, nombre, cedula, userId: currentUserId }); showMessage('Cliente guardado.', 'success'); clearFormCliente(); }
            catch (e) { console.error(e); showMessage('Error al guardar.', 'error'); }
        }
        async function handleUpdateCliente() {
            const docId = selectCliente.value; if (!docId || !currentUserId) return;
            const tratamiento = document.getElementById('clienteTratamiento').value, nombre = document.getElementById('clienteNombre').value.trim(), cedula = document.getElementById('clienteCedula').value.trim();
            if (localClientes.some(c => c.cedula === cedula && c.id !== docId)) return showMessage('Cédula pertenece a otro.', 'error');
            try { await updateDoc(getPublicDoc('clientes', docId), { tratamiento, nombre, cedula }); showMessage('Cliente actualizado.', 'success'); }
            catch (e) { console.error(e); showMessage('Error al actualizar.', 'error'); }
        }
        async function handleDeleteCliente() {
            const docId = selectCliente.value; if (!docId || !currentUserId) return;
            if (!confirm('¿Eliminar cliente?')) return;
            try { await deleteDoc(getPublicDoc('clientes', docId)); showMessage('Eliminado.', 'success'); clearFormCliente(); }
            catch (e) { console.error(e); showMessage('Error al eliminar.', 'error'); }
        }

        // Conceptos (Ruta Pública para compartir)
        const conceptosDefault = ["Actividades Comerciales", "Honorarios profesionales libre ejercicio", "Alquiler de inmueble"];
        async function loadConceptos() {
            try {
                const docSnap = await getDoc(getPublicDoc('config', 'conceptos_main'));
                conceptosGuardados = (docSnap.exists() && docSnap.data().lista) ? docSnap.data().lista : [...conceptosDefault];
                if (!docSnap.exists()) await setDoc(getPublicDoc('config', 'conceptos_main'), { lista: conceptosGuardados });
                updateConceptosUI();
            } catch (e) { console.error("Err conceptos", e); conceptosGuardados = [...conceptosDefault]; updateConceptosUI(); }
        }
        function updateConceptosUI() {
            const select = document.getElementById('conceptosSelect'), datalist = document.getElementById('conceptos-list');
            select.innerHTML = ''; datalist.innerHTML = '';
            conceptosGuardados.forEach((c, i) => {
                const opt = document.createElement('option'); opt.value = i; opt.textContent = c; select.appendChild(opt);
                const dlOpt = document.createElement('option'); dlOpt.value = c; datalist.appendChild(dlOpt);
            });
            document.getElementById('conceptoEditInput').value = '';
            document.getElementById('conceptoBtnAgregar').style.display = 'inline-flex';
            document.getElementById('conceptoBtnGuardarEdicion').style.display = 'none'; edicionConceptoIndex = null;
        }
        async function saveConceptos() {
            if (!currentUserId) return showMessage('Inicie sesión.', 'error');
            try { await updateDoc(getPublicDoc('config', 'conceptos_main'), { lista: conceptosGuardados }); updateConceptosUI(); return true; }
            catch (e) { console.error(e); showMessage('Error al guardar conceptos.', 'error'); return false; }
        }

        // --- GENERACIÓN DE PDF ---
        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const incomeItems = document.querySelectorAll('.income-item');
            if (incomeItems.length === 0) return showMessage('Agregue al menos un ingreso.', 'error');
            let valid = true; incomeItems.forEach(i => { if (!i.querySelector('.income-concept').value || parseFloat(parseFormattedNumber(i.querySelector('.income-amount').value)) <= 0) valid = false; });
            if (!valid) return showMessage('Revise los montos de ingreso.', 'error');

            showMessage('Generando PDF...', 'info'); document.getElementById('generatePdfBtn').disabled = true;
            try {
                let sealDataUrl = null, w = 0, h = 0;
                const file = contadorSelloInput.files[0], img = document.getElementById('selloPreview');
                if (file) {
                    sealDataUrl = await fileToDataUrl(file); const dim = await getImageDimensions(sealDataUrl); w = dim.width; h = dim.height;
                } else if (img.src && img.complete && img.naturalWidth > 0 && !img.src.startsWith('http')) {
                     // Si es dataURL ya cargado
                     sealDataUrl = img.src; const dim = await getImageDimensions(sealDataUrl); w = dim.width; h = dim.height;
                } else if (img.src && img.complete && img.naturalWidth > 0) {
                    // Si es URL remota (Firebase), usar canvas para evitar CORS al generar PDF
                    const canvas = document.createElement('canvas'); canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                    canvas.getContext('2d').drawImage(img, 0, 0); sealDataUrl = canvas.toDataURL('image/png'); w = img.naturalWidth; h = img.naturalHeight;
                }
                buildPDF(sealDataUrl, w, h); showMessage('PDF generado.', 'success');
            } catch (e) { console.error(e); showMessage('Error al generar PDF: ' + e.message, 'error'); }
            finally { document.getElementById('generatePdfBtn').disabled = false; }
        });

        function buildPDF(sealUrl, sW, sH) {
            const doc = new window.jspdf.jsPDF('p', 'pt', 'letter');
            const getData = id => document.getElementById(id).value;
            const [cNom, cCpc, cRif, cliTrat, cliNom, cliCed] = ['contadorNombre','contadorCpc','contadorRif','clienteTratamiento','clienteNombre','clienteCedula'].map(getData);
            const [entidad, motivo, lugar, fDoc, fDes, fHas] = ['entidadDirigida','motivoInforme','lugar','fechaDocumento','fechaDesde','fechaHasta'].map(getData);
            const fDocL = `${lugar}, ${formatDate(fDoc, {format:'dd de M de yyyy'})}`, fDesL = formatDate(fDes, {format:'dd de M de yyyy'}), fHasL = formatDate(fHas, {format:'dd de M de yyyy'});
            
            let total = 0; const rows = [];
            document.querySelectorAll('.income-item').forEach(i => {
                const m = parseFloat(parseFormattedNumber(i.querySelector('.income-amount').value)) || 0;
                if (m > 0) { rows.push([i.querySelector('.income-concept').value, `Bs. ${formatCurrency(m)}`]); total += m; }
            });

            const margin = 60, pW = doc.internal.pageSize.getWidth(), usableW = pW - margin * 2; let y = 140;
            doc.setFont('helvetica', 'normal');
            const addTxt = (txt, opt={}) => {
                doc.setFontSize(opt.sz || 11); doc.setFont('helvetica', opt.st || 'normal');
                const lines = doc.splitTextToSize(txt, usableW - (opt.ind || 0));
                const h = lines.length * (opt.sz || 11) * 1.15;
                if (y + h > doc.internal.pageSize.getHeight() - 85) { doc.addPage(); y = 140; }
                doc.text(txt, opt.al === 'center' ? pW/2 : (opt.al === 'right' ? pW - margin : margin + (opt.ind || 0)), y, { align: opt.al || 'justify', maxWidth: usableW - (opt.ind || 0) });
                y += h + (opt.sp || 15);
            };

            addTxt('INFORME DE ENCARGOS DE ASEGURAMIENTO DEL CONTADOR PÚBLICO INDEPENDIENTE', {st:'bold', al:'center', sp:30});
            addTxt('Alcance', {st:'bold', al:'left', sp:15});
            addTxt(`He revisado la evidencia inherente a los ingresos percibidos por el ${cliTrat} ${cliNom}, con cedula de identidad N.º ${cliCed}, durante el periodo comprendido desde el ${formatDate(fDes)} hasta el ${formatDate(fHas)}, presentado en la relación de ingresos adjunta.`, {ind:20, sp:20});
            addTxt('Responsabilidad de la persona que percibe los ingresos', {st:'bold', al:'left', sp:15});
            addTxt(`El ${cliTrat} ${cliNom}, es responsable de la preparación y presentación del importe de sus ingresos, incluyendo la integridad, legalidad y veracidad de los documentos suministrados.`, {ind:20, sp:20});
            addTxt('Responsabilidad del Contador Público Independiente', {st:'bold', al:'left', sp:15});
            addTxt(`Mi responsabilidad es expresar una opinión sobre la relación de ingresos obtenida por el ${cliTrat} ${cliNom}, durante el periodo señalado de acuerdo con mis procedimientos, realizados de conformidad con la Norma Internacional de Encargos de Aseguramiento NIEA 3000.`, {ind:20, sp:15});
            
            doc.addPage(); y = 140;
            addTxt('Opinión', {st:'bold', al:'left', sp:15});
            addTxt('Con base en el trabajo efectuado descrito en este informe, no ha llamado mi atención algo que me haga pensar que la relación de ingresos que se anexa, en todos los aspectos importantes, no sea razonable.', {ind:20, sp:25});
            addTxt('Usuarios Previstos y Propósitos', {st:'bold', al:'left', sp:15});
            addTxt(`Este informe está dirigido únicamente al ${entidad} el cual lo ha requerido para ${motivo}.`, {ind:20, sp:40});

            // Firma
            let sigH = 60; if (cRif) sigH += 15;
            if (y + sigH + 40 > doc.internal.pageSize.getHeight() - 85) { doc.addPage(); y = 140; }
            
            const sigY = doc.internal.pageSize.getHeight() - 85 - sigH - 30;
            if (sealUrl && sW > 0 && sH > 0) {
                const ratio = Math.min((5.3 * 28.35) / sW, (2.1 * 28.35) / sH, 1);
                doc.addImage(sealUrl, 'PNG', pW - margin - (sW * ratio), sigY - (sH * ratio), sW * ratio, sH * ratio);
            }
            
            y = doc.internal.pageSize.getHeight() - 85 - sigH - 15;
            addTxt(fDocL, {al:'left', sp:30});
            addTxt('________________________________', {al:'center', sp:12});
            addTxt(cNom, {st:'bold', al:'center', sp:12});
            addTxt(`Contador Público C.P.C. N ${cCpc}`, {al:'center', sp:12});
            if (cRif) addTxt(`Rif: ${cRif}`, {al:'center', sp:12});

            // Anexo
            doc.addPage(); y = 140;
            addTxt(cliNom.toUpperCase(), {st:'bold', al:'center', sp:10});
            addTxt(cliCed, {st:'bold', al:'center', sp:30});
            addTxt('RELACIÓN DE INGRESOS (BS)', {st:'bold', al:'center', sp:20});
            addTxt(`Correspondientes al período desde el ${fDesL} hasta el ${fHasL}:`, {sp:20});
            
            doc.autoTable({
                head: [['Concepto', 'Monto (Bs.)']], body: rows,
                foot: [['Total Ingresos', `Bs. ${formatCurrency(total)}`]],
                startY: y, margin: {left:margin, right:margin}, theme: 'grid',
                headStyles: {fillColor:[220,220,255], textColor:20, halign:'center', fontStyle:'bold'},
                columnStyles: {0:{halign:'left'}, 1:{halign:'right'}},
                didDrawPage: (d) => y = d.cursor.y
            });
            y = doc.lastAutoTable.finalY + 40;
            
            addTxt('_____________________________________', {al:'center', sp:12});
            addTxt(cliNom, {st:'bold', al:'center', sp:12});
            addTxt(`C.I. ${cliCed}`, {al:'center', sp:12});
            
            doc.save(`Informe_${cliNom.replace(/\s+/g, '_')}.pdf`);
        }

        // --- INICIALIZACIÓN ---
        async function init() {
            loginStatus.classList.remove('hidden'); loadingContainer.classList.remove('hidden');
            onAuthStateChanged(auth, (user) => {
                currentUserId = user ? user.uid : null;
                loginContainer.classList.toggle('hidden', !!user);
                appContainer.classList.toggle('hidden', !user);
                userInfo.textContent = user ? (user.isAnonymous ? 'Sesión Anónima' : 'Conectado') : '';
                if (user) {
                    unsubContadores(); unsubClientes();
                    unsubContadores = onSnapshot(getPublicCol('contadores'), (snap) => {
                        localContadores = snap.docs.map(d => ({id: d.id, ...d.data()})); loadDropdownsUI();
                        if (selectContador.value && !localContadores.find(c => c.id === selectContador.value)) clearFormContador();
                    });
                    unsubClientes = onSnapshot(getPublicCol('clientes'), (snap) => {
                        localClientes = snap.docs.map(d => ({id: d.id, ...d.data()})); loadDropdownsUI();
                        if (selectCliente.value && !localClientes.find(c => c.id === selectCliente.value)) clearFormCliente();
                    });
                    loadConceptos(); addIncomeItem(); setFechasDefault();
                } else {
                    unsubContadores(); unsubClientes(); clearForm();
                }
                loginStatus.classList.add('hidden'); loadingContainer.classList.add('hidden');
            });

            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth failed", e); showMessage('Error de inicio de sesión. Intente nuevamente.', 'error');
                loadingContainer.classList.add('hidden'); loginStatus.classList.remove('hidden');
                document.getElementById('google-login-btn').classList.remove('hidden');
            }
        }

        // Event Listeners
        googleLoginBtn.addEventListener('click', async () => {
            loginStatus.classList.add('hidden'); loadingContainer.classList.remove('hidden');
            try { await signInAnonymously(auth); } 
            catch (e) { showMessage(e.message, 'error'); loadingContainer.classList.add('hidden'); loginStatus.classList.remove('hidden'); }
        });
        logoutBtn.addEventListener('click', () => signOut(auth));
        clearFormBtn.addEventListener('click', clearForm);
        addIncomeBtn.addEventListener('click', addIncomeItem);
        document.getElementById('clienteCedula').addEventListener('input', formatCedula);
        document.getElementById('contadorRif').addEventListener('input', formatRif);
        document.getElementById('contadorCpc').addEventListener('input', formatSimpleThousands);
        selectContador.addEventListener('change', (e) => fillContadorForm(e.target.value));
        selectCliente.addEventListener('change', (e) => fillClienteForm(e.target.value));
        document.getElementById('saveContadorBtn').addEventListener('click', handleSaveContador);
        document.getElementById('updateContadorBtn').addEventListener('click', handleUpdateContador);
        document.getElementById('deleteContadorBtn').addEventListener('click', handleDeleteContador);
        document.getElementById('saveClienteBtn').addEventListener('click', handleSaveCliente);
        document.getElementById('updateClienteBtn').addEventListener('click', handleUpdateCliente);
        document.getElementById('deleteClienteBtn').addEventListener('click', handleDeleteCliente);
        contadorSelloInput.addEventListener('change', function() {
            if (this.files[0]) {
                const r = new FileReader(); r.onload = (e) => { selloPreview.src = e.target.result; selloPreview.classList.remove('hidden'); };
                r.readAsDataURL(this.files[0]);
            }
        });
        
        // Listeners Conceptos
        document.getElementById('conceptoBtnAgregar').addEventListener('click', () => {
            const val = document.getElementById('conceptoEditInput').value.trim();
            if (val && !conceptosGuardados.includes(val)) { conceptosGuardados.push(val); saveConceptos(); }
        });
        document.getElementById('conceptoBtnEditar').addEventListener('click', () => {
            const idx = document.getElementById('conceptosSelect').value;
            if (idx !== "") {
                document.getElementById('conceptoEditInput').value = conceptosGuardados[idx]; edicionConceptoIndex = idx;
                document.getElementById('conceptoBtnAgregar').style.display = 'none'; document.getElementById('conceptoBtnGuardarEdicion').style.display = 'inline-flex';
            }
        });
        document.getElementById('conceptoBtnGuardarEdicion').addEventListener('click', () => {
            const val = document.getElementById('conceptoEditInput').value.trim();
            if (val && edicionConceptoIndex !== null) { conceptosGuardados[edicionConceptoIndex] = val; saveConceptos(); }
        });
        document.getElementById('conceptoBtnEliminar').addEventListener('click', () => {
            const idx = document.getElementById('conceptosSelect').value;
            if (idx !== "") { conceptosGuardados.splice(idx, 1); saveConceptos(); }
        });

        init();
    </script>

</body>
</html>
