<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Aseguramiento (con Login)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SDK de PayPal -->
    <!-- Reemplaza 'YOUR_PAYPAL_CLIENT_ID' con tu Client ID real de PayPal -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=USD"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // Función para mostrar mensajes (GLOBAL)
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            if (!container) return; 
            const msgDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            msgDiv.className = `p-4 ${bgColor} text-white rounded-lg shadow-lg mb-2 transition-all duration-300 ease-out transform translate-x-full`;
            msgDiv.textContent = message;
            container.appendChild(msgDiv);
            // Animación de entrada
            setTimeout(() => { msgDiv.classList.remove('translate-x-full'); msgDiv.classList.add('translate-x-0'); }, 10);
            // Animación de salida
            setTimeout(() => {
                msgDiv.classList.add('opacity-0'); msgDiv.classList.add('translate-x-full');
                setTimeout(() => { if (container.contains(msgDiv)) container.removeChild(msgDiv); }, 500);
            }, 4000); // Aumentado a 4 segundos
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-dancing-script { font-family: 'Dancing Script', cursive; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%2D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65em auto;
            padding-right: 2.5rem;
        }
        .gestion-btn { display: none; }
        .hidden { display: none !important; }
        
        /* Estilos para Modales */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.75); /* bg-gray-900 bg-opacity-75 */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-xl */
            max-width: 90%;
            width: 500px;
            transform: scale(0.95);
            transition: all 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <!-- Contenedor de Mensajes Globales -->
    <div id="message-container" class="fixed top-5 right-5 z-[100]"></div>
    
    <!-- Pantalla de Carga -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[90]">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white text-lg font-medium">Cargando...</p>
        </div>
    </div>
    
    <!-- Contenedor de Autenticación -->
    <div id="auth-container" class="container max-w-md mx-auto bg-white shadow-xl rounded-lg overflow-hidden p-8 hidden">
        <h2 class="text-2xl font-bold text-center text-purple-700 mb-6 font-dancing-script">Iniciar Sesión o Registrarse</h2>
        <div class="space-y-4">
            <button id="googleLoginBtn" class="w-full py-2.5 px-4 bg-white border border-gray-300 text-gray-700 font-semibold rounded-full shadow-md hover:bg-gray-50 focus:outline-none transition-transform duration-150 ease-in-out active:scale-95 flex items-center justify-center">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.06 6.25C12.72 13.94 17.94 9.5 24 9.5z"/><path fill="#34A853" d="M46.94 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h12.8c-.55 2.72-2.16 4.97-4.66 6.54l7.68 5.95C43.8 37.6 46.94 31.6 46.94 24.5z"/><path fill="#FBBC05" d="M10.62 28.47c-.7-2.09-1.1-4.31-1.1-6.69s.4-4.6.1-6.69L2.56 13.22C.9 16.48 0 20.12 0 24c0 3.88.9 7.52 2.56 10.78l8.06-6.25z"/><path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.68-5.95c-2.11 1.42-4.8 2.27-7.91 2.27-6.06 0-11.28-4.44-13.22-10.43L2.56 34.78C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                Iniciar sesión con Google
            </button>
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-500 text-sm">O inicia con tu correo</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <div><label for="loginEmail" class="block text-sm font-medium text-gray-700">Correo Electrónico</label><input type="email" id="loginEmail" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
            <div><label for="loginPassword" class="block text-sm font-medium text-gray-700">Contraseña</label><input type="password" id="loginPassword" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
            <p id="authMessage" class="text-sm text-red-600 text-center"></p>
            <div class="flex flex-col md:flex-row gap-4">
                <button id="loginBtn" class="flex-1 py-2 px-4 bg-purple-700 text-white font-semibold rounded-full shadow-md hover:bg-purple-800 transition-transform duration-150 ease-in-out active:scale-95">Iniciar Sesión</button>
                <button id="registerBtn" class="flex-1 py-2 px-4 bg-yellow-200 text-yellow-800 font-semibold rounded-full shadow-md hover:bg-yellow-300 transition-transform duration-150 ease-in-out active:scale-95">Registrarse</button>
            </div>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="container max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden hidden">
        <div class="bg-purple-700 p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-3xl md:text-4xl font-bold text-white flex items-center font-dancing-script">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                Informe de Aseguramiento
            </h1>
            <div class="text-center md:text-right">
                <p class="text-sm text-purple-200" id="userEmailDisplay"></p>
                <!-- Info del Plan del Usuario -->
                <div id="userPlanInfo" class="text-xs text-yellow-200 bg-black bg-opacity-20 px-2 py-1 rounded-full inline-block mt-1"></div>
                <button id="logoutBtn" class="text-sm text-yellow-200 hover:text-yellow-100 font-semibold mt-1">Cerrar Sesión</button>
            </div>
        </div>

        <div class="p-6 md:p-8 pb-0 flex justify-end">
            <button type="button" id="clearFormBtn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15m0 0l6.75-6.75M4.5 12l6.75 6.75" /></svg>
                Limpiar Formulario
            </button>
        </div>

        <form id="report-form" class="p-6 md:p-8 pt-6 space-y-6">
            <!-- Sección Contador -->
            <div class="form-group">
                <select id="selectContador" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50"><option value="">-- Selecciona Contador --</option></select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                    Datos del Contador
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Contador</label><input type="text" id="contadorNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">RIF del Contador</label><input type="text" id="contadorRif" placeholder="Ej: V-12345678-9" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"></div>
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">Núm. C.P.C.</label><input type="text" id="contadorCpc" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
                </div>
                <div class="form-group mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sello del Contador (Opcional)</label>
                    <input type="file" id="contadorSello" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" accept="image/png">
                    <small class="text-xs text-gray-500">Subir PNG. Máx: 5.30cm (ancho) x 2.10cm (alto).</small>
                    <img id="selloPreview" src="" alt="Vista previa del sello" class="mt-2 h-16 object-contain hidden" />
                </div>
                <div class="text-right mt-4 space-x-2">
                    <button type="button" id="deleteContadorBtn" class="gestion-btn" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    <button type="button" id="updateContadorBtn" class="gestion-btn" title="Actualizar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button type="button" id="saveContadorBtn" title="Guardar como Nuevo"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg></button>
                </div>
            </fieldset>

            <!-- Sección Cliente -->
             <div class="form-group">
                <select id="selectCliente" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50"><option value="">-- Selecciona Cliente --</option></select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    Datos del Cliente
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">Tratamiento</label><select id="clienteTratamiento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"><option value="Sr.">Sr.</option><option value="Sra.">Sra.</option></select></div>
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label><input type="text" id="clienteNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">N.º de Cédula</label><input type="text" id="clienteCedula" placeholder="Ej: V-12345678" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
                </div>
                 <div class="text-right mt-4 space-x-2">
                    <button type="button" id="deleteClienteBtn" class="gestion-btn" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    <button type="button" id="updateClienteBtn" class="gestion-btn" title="Actualizar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button type="button" id="saveClienteBtn" title="Guardar como Nuevo"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg></button>
                </div>
            </fieldset>

            <!-- Sección Informe -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Datos del Informe
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="entidadDirigida" class="block text-sm font-medium text-gray-700 mb-1">Entidad a la que se dirige</label>
                        <input type="text" id="entidadDirigida" list="bancos-list" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="bancos-list">
                            <option value="Banco de Venezuela, S.A. Banco Universal"></option><option value="Banesco Banco Universal, C.A."></option><option value="Banco Provincial, S.A. Banco Universal"></option><option value="Banco Mercantil, C.A. Banco Universal"></option><option value="Bancaribe, C.A. Banco Universal"></option><option value="Banco Nacional de Crédito, C.A. Banco Universal"></option><option value="Banco Exterior, C.A. Banco Universal"></option><option value="Banco del Tesoro, C.A. Banco Universal"></option><option value="Bicentenario Banco Universal, C.A."></option><option value="100% Banco, Banco Universal"></option><option value="Banplus Banco Universal, C.A."></option><option value="Banca Amiga, C.A. Banco Universal"></option><option value="Mi Banco, C.A. Banco de Desarrollo"></option><option value="Banco Venezolano de Crédito, S.A. Banco Universal"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="motivoInforme" class="block text-sm font-medium text-gray-700 mb-1">Motivo del Informe</label>
                        <input type="text" id="motivoInforme" list="motivos-list" placeholder="Ej: Solicitud de crédito" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="motivos-list">
                            <option value="Solicitud de crédito"></option><option value="Apertura de la Cuenta Bancaria"></option><option value="Actualización de datos"></option><option value="Trámite de visa"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="lugar" class="block text-sm font-medium text-gray-700 mb-1">Lugar</label>
                        <input type="text" id="lugar" list="ciudades-list" placeholder="Ej: Barquisimeto" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="ciudades-list">
                            <option value="Caracas"></option><option value="Maracaibo"></option><option value="Valencia"></option><option value="Barquisimeto"></option><option value="Maracay"></option><option value="Ciudad Guayana"></option><option value="San Cristóbal"></option><option value="Mérida"></option><option value="Barcelona"></option><option value="Cumaná"></option><option value="Maturín"></option><option value="Porlamar"></option><option value="Barinas"></option><option value="Coro"></option><option value="San Felipe"></option><option value="San Juan de los Morros"></option><option value="Quibor"></option><option value="El Tocuyo"></option><option value="Sanare"></option>
                        </datalist>
                    </div>
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">Fecha del Documento</label><input type="date" id="fechaDocumento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">Período - Desde</label><input type="date" id="fechaDesde" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
                    <div class="form-group"><label class="block text-sm font-medium text-gray-700 mb-1">Período - Hasta</label><input type="date" id="fechaHasta" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required></div>
                </div>
            </fieldset>

            <!-- Sección Ingresos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    Detalle de los Ingresos del Período
                </legend>
                <datalist id="conceptos-list">
                    <!-- Se llena dinámicamente desde Firebase -->
                </datalist>
                <div id="income-details" class="space-y-3 mb-4"></div>
                <button type="button" id="addIncomeItemBtn" class="btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Agregar Concepto
                </button>
            </fieldset>

            <!-- Sección Gestionar Conceptos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Gestionar Conceptos de Ingreso
                </legend>
                <div class="space-y-4">
                    <div>
                        <label for="conceptosSelect" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Concepto para Editar/Eliminar</label>
                        <select id="conceptosSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                             <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                    <div>
                        <label for="conceptoEditInput" class="block text-sm font-medium text-gray-700 mb-1">Concepto (para agregar o editar)</label>
                        <input type="text" id="conceptoEditInput" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" placeholder="Escribe el nombre del nuevo concepto aquí">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" id="conceptoBtnAgregar" class="btn-save" title="Agregar Nuevo"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>
                        <button type="button" id="conceptoBtnEditar" class="btn-warning" title="Cargar para Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                        <button type="button" id="conceptoBtnGuardarEdicion" class="btn-save hidden" title="Guardar Cambios"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                        <button type="button" id="conceptoBtnCancelarEdicion" class="p-2.5 font-semibold rounded-full shadow-md bg-gray-200 text-gray-800 hover:bg-gray-300 focus:outline-none hidden" title="Cancelar Edición"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                        <button type="button" id="conceptoBtnEliminar" class="btn-danger" title="Eliminar Seleccionado"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>
            </fieldset>

            <div class="pt-6 border-t border-gray-200 flex justify-center">
                 <button type="submit" class="btn-primary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Generar PDF
                </button>
            </div>
        </form>
    </div>

    <!-- ========= MODALES DE PLANES Y PAGOS ========= -->

    <!-- Modal: Límite Alcanzado / Premium -->
    <div id="premium-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-purple-800 mb-4 font-dancing-script">¡Has alcanzado tu límite!</h3>
            <p class="mb-4 text-gray-600">Has usado tus 3 informes gratuitos. Para generar informes ilimitados, actualiza a Premium.</p>
            
            <div class="p-4 bg-purple-50 rounded-lg mb-4">
                <h4 class="font-semibold text-purple-700">Plan Premium - $15.00 USD</h4>
                <p class="text-sm text-purple-600">Acceso ilimitado a la generación de informes durante 1 año.</p>
            </div>

            <div class="space-y-4">
                <!-- Opción 1: PayPal -->
                <div id="paypal-button-container" class="w-full">
                    <!-- Los botones de PayPal se renderizarán aquí -->
                </div>
                
                <!-- Opción 2: Pago Móvil -->
                <button id="showPagoMovilBtn" class="w-full py-2.5 px-4 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 transition-transform duration-150 ease-in-out active:scale-95">
                    Pagar con Pago Móvil
                </button>
                
                <!-- Opción 3: Anuncio Recompensado -->
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-sm">O mira un anuncio</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                
                <button id="rewardedAdBtn" class="w-full py-2.5 px-4 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition-transform duration-150 ease-in-out active:scale-95">
                    Ver Anuncio por 1 Informe Extra
                </button>
            </div>

            <button onclick="hideModals()" class="mt-6 text-sm text-gray-500 hover:text-gray-700 w-full text-center">Cancelar</button>
        </div>
    </div>

    <!-- Modal: Pago Móvil -->
    <div id="pagomovil-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-blue-700 mb-4 font-dancing-script">Pago Móvil</h3>
            <p class="mb-4 text-gray-600">Realiza el pago a los siguientes datos y sube el comprobante. Tu cuenta se activará manualmente en un plazo de 24h.</p>
            
            <div class="p-4 bg-blue-50 rounded-lg mb-4 text-gray-700 space-y-2">
                <p><strong>Banco:</strong> [Nombre de tu Banco]</p>
                <p><strong>CI:</strong> [Tu Cédula]</p>
                <p><strong>Teléfono:</strong> [Tu Teléfono]</p>
                <p><strong>Monto:</strong> 15 USD (o su equivalente en Bs. a la tasa BCV del día)</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="pagoMovilProof" class="block text-sm font-medium text-gray-700 mb-1">Subir Comprobante (Imagen)</label>
                    <input type="file" id="pagoMovilProof" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                </div>
                <button id="submitPagoMovilBtn" class="w-full py-2.5 px-4 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 transition-transform duration-150 ease-in-out active:scale-95 disabled:opacity-50" disabled>
                    Subir y Notificar Pago
                </button>
            </div>
            
            <button onclick="hideModals()" class="mt-6 text-sm text-gray-500 hover:text-gray-700 w-full text-center">Volver</button>
        </div>
    </div>
    
    <!-- Modal: Anuncio (Simulación) -->
    <div id="ad-loading-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <svg class="animate-spin h-10 w-10 text-purple-700 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-medium text-gray-700">Cargando anuncio... <span id="ad-timer">5</span>s</p>
            <p class="text-sm text-gray-500 mt-2">Gracias por tu paciencia. Ganarás 1 informe extra.</p>
        </div>
    </div>


    <!-- ========= FIN MODALES ========= -->

    <script type="module">
        // --- Imports de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, serverTimestamp, setLogLevel, getDocs, increment, Timestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

        // --- Configuración y Variables Globales ---
        const firebaseConfig = { apiKey: "AIzaSyAJiKG4Q0foMbkmBLPk8kYU31FlE3dIfEQ", authDomain: "formatoaseguramiento.firebaseapp.com", projectId: "formatoaseguramiento", storageBucket: "formatoaseguramiento.firebasestorage.app", messagingSenderId: "781371601755", appId: "1:781371601755:web:4013d52de8196c47c3e07e" };
        const appId = firebaseConfig.appId; 
        let app, auth, db, storage, currentUserId = null;
        let contadoresUnsubscribe = () => {}, clientesUnsubscribe = () => {}, conceptosUnsubscribe = () => {}, userProfileUnsubscribe = () => {};
        
        let userPlanStatus = null; // Almacena el estado del plan del usuario
        let localContadores = [], localClientes = [], localConceptos = [], edicionConceptoId = null;

        // --- Selectores de DOM (UI Principal) ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const authMessage = document.getElementById('authMessage');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const userPlanInfo = document.getElementById('userPlanInfo');
        const contadorSelloInput = document.getElementById('contadorSello');
        const selloPreview = document.getElementById('selloPreview');

        // --- Selectores de DOM (Modales) ---
        const premiumModal = document.getElementById('premium-modal');
        const pagomovilModal = document.getElementById('pagomovil-modal');
        const adLoadingModal = document.getElementById('ad-loading-modal');
        const pagoMovilProofInput = document.getElementById('pagoMovilProof');
        const submitPagoMovilBtn = document.getElementById('submitPagoMovilBtn');

        // --- Constantes de Estilo Botones ---
        const btnBase = "py-2 px-3 text-sm font-semibold rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 inline-flex items-center justify-center";
        const btnLilac = `${btnBase} bg-purple-200 text-purple-800 hover:bg-purple-300 focus:ring-purple-400 p-2.5`;
        const btnYellow = `${btnBase} bg-yellow-200 text-yellow-800 hover:bg-yellow-300 focus:ring-yellow-300`;
        const btnPrimary = "w-full py-3 px-6 bg-purple-700 text-white font-bold rounded-full shadow-lg hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 flex items-center justify-center";
        
        // --- Lógica de Autenticación (MOVIDA ARRIBA) ---
        function setupAuthListeners() {
            const loginEmail = document.getElementById('loginEmail'), loginPassword = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('loginBtn'), registerBtn = document.getElementById('registerBtn'), googleLoginBtn = document.getElementById('googleLoginBtn'), logoutBtn = document.getElementById('logoutBtn');

            if (registerBtn) registerBtn.addEventListener('click', async (e) => { e.preventDefault(); authMessage.textContent = ''; try { await createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value); } catch (error) { authMessage.textContent = `Error: ${traducirErrorAuth(error.code)}`; } });
            if (googleLoginBtn) googleLoginBtn.addEventListener('click', async (e) => { e.preventDefault(); authMessage.textContent = ''; try { await setPersistence(auth, browserLocalPersistence); await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { authMessage.textContent = `Error: ${traducirErrorAuth(error.code)}`; } });
            if (loginBtn) loginBtn.addEventListener('click', async (e) => { e.preventDefault(); authMessage.textContent = ''; try { await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value); } catch (error) { authMessage.textContent = `Error: ${traducirErrorAuth(error.code)}`; } });
            if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth).catch((error) => showMessage("Error al cerrar sesión.", "error")));
        }

        function traducirErrorAuth(code) { const errors = { 
                'auth/invalid-email': 'Email inválido.', 
                'auth/user-not-found': 'Usuario no encontrado.', 
                'auth/wrong-password': 'Contraseña incorrecta.', 
                'auth/invalid-credential': 'Credenciales inválidas. Revisa tu correo y contraseña.',
                'auth/email-already-in-use': 'Email ya registrado.', 
                'auth/weak-password': 'Contraseña muy débil.', 
                'auth/popup-closed-by-user': 'Inicio de sesión cancelado.' 
            }; 
            // CAMBIO: Mostrar el código de error si no es reconocido
            return errors[code] || `Ocurrió un error: ${code}`; 
        }

        // --- Inicialización de Firebase ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app); // Inicializar Storage
            setLogLevel('Debug'); // Para depuración

            // Listeners de Autenticación
            setupAuthListeners();
            
            // Listener de estado de autenticación
            onAuthStateChanged(auth, (user) => {
                loadingOverlay.classList.add('hidden');
                if (user) {
                    currentUserId = user.uid;
                    userEmailDisplay.textContent = user.email;
                    appContainer.classList.remove('hidden');
                    authContainer.classList.add('hidden');
                    
                    // Configurar perfil de usuario y cargar datos
                    setupUserProfile(user.uid); 
                    loadDropdowns();
                    inicializarConceptos();
                } else {
                    currentUserId = null;
                    userPlanStatus = null;
                    appContainer.classList.add('hidden');
                    authContainer.classList.remove('hidden');
                    
                    // Limpiar listeners de snapshots
                    if (contadoresUnsubscribe) contadoresUnsubscribe();
                    if (clientesUnsubscribe) clientesUnsubscribe();
                    if (conceptosUnsubscribe) conceptosUnsubscribe();
                    if (userProfileUnsubscribe) userProfileUnsubscribe();
                    
                    clearForm();
                }
            });
        } catch (error) {
            loadingOverlay.classList.add('hidden'); authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); authMessage.textContent = error.message || "Error al conectar.";
        }

        // --- Lógica de Autenticación ---
        // (Las funciones se movieron arriba, antes del bloque 'try')

        // --- Gestión de Perfil y Planes de Usuario ---

        function getCollectionPath(collectionName) { return currentUserId ? `artifacts/${appId}/users/${currentUserId}/${collectionName}` : null; }
        function getUserProfileRef() { return currentUserId ? doc(db, `artifacts/${appId}/users/${currentUserId}/profile`, 'status') : null; }

        async function setupUserProfile(userId) {
            if (userProfileUnsubscribe) userProfileUnsubscribe(); // Limpiar listener anterior
            
            const profileRef = getUserProfileRef();
            if (!profileRef) return;

            userProfileUnsubscribe = onSnapshot(profileRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    // El usuario es nuevo, crear perfil free
                    await createFreeUserProfile(profileRef);
                } else {
                    userPlanStatus = docSnap.data();
                    // Verificar si el plan premium ha expirado
                    await checkPremiumExpiry(profileRef, userPlanStatus);
                }
                updatePlanUI(); // Actualizar la UI con la info del plan
            }, (error) => {
                console.error("Error al escuchar perfil de usuario:", error);
                showMessage("Error al cargar tu plan.", "error");
            });
        }

        async function createFreeUserProfile(profileRef) {
            try {
                const freePlan = {
                    plan: 'free',
                    reportsGenerated: 0,
                    premiumUntil: null,
                    rewardedReportsAvailable: 0,
                    createdAt: serverTimestamp()
                };
                await setDoc(profileRef, freePlan);
                userPlanStatus = freePlan;
            } catch (e) {
                console.error("Error creando perfil de usuario:", e);
            }
        }

        async function checkPremiumExpiry(profileRef, status) {
            if (status.plan === 'premium' && status.premiumUntil && status.premiumUntil.toDate() < new Date()) {
                // El plan premium ha expirado
                try {
                    await updateDoc(profileRef, {
                        plan: 'free',
                        premiumUntil: null,
                        reportsGenerated: 0 // Reiniciar conteo
                    });
                    showMessage("Tu plan Premium ha expirado. Has vuelto al plan Free.", "info");
                } catch (e) {
                    console.error("Error al revertir plan premium:", e);
                }
            }
        }

        function updatePlanUI() {
            if (!userPlanStatus) {
                userPlanInfo.textContent = 'Cargando plan...';
                return;
            }
            if (userPlanStatus.plan === 'premium') {
                userPlanInfo.textContent = `⭐ Usuario Premium (Vence: ${fmtDate(userPlanStatus.premiumUntil.toDate().toISOString().split('T')[0])})`;
                userPlanInfo.className = 'text-xs text-yellow-300 bg-black bg-opacity-20 px-2 py-1 rounded-full inline-block mt-1';
            } else {
                const reportsLeft = 3 - userPlanStatus.reportsGenerated;
                const rewards = userPlanStatus.rewardedReportsAvailable || 0;
                userPlanInfo.textContent = `Plan Free (${reportsLeft} informes gratis) + (${rewards} informes por anuncios)`;
                userPlanInfo.className = 'text-xs text-gray-200 bg-black bg-opacity-20 px-2 py-1 rounded-full inline-block mt-1';
            }
        }

        // --- Lógica de Generación de Informes (Validación) ---

        function canGenerateReport() {
            if (!userPlanStatus) return { allow: false, reason: 'no_auth' };

            // 1. Usuario Premium
            if (userPlanStatus.plan === 'premium') {
                return { allow: true, type: 'premium' };
            }

            // 2. Usuario Free con Informes por Anuncio
            if (userPlanStatus.rewardedReportsAvailable > 0) {
                return { allow: true, type: 'rewarded' };
            }

            // 3. Usuario Free con Informes Gratuitos
            if (userPlanStatus.reportsGenerated < 3) {
                return { allow: true, type: 'free' };
            }

            // 4. Límite alcanzado
            return { allow: false, reason: 'limit_reached' };
        }

        async function incrementReportCount(type) {
            const profileRef = getUserProfileRef();
            if (!profileRef) return;

            try {
                if (type === 'free') {
                    await updateDoc(profileRef, { reportsGenerated: increment(1) });
                } else if (type === 'rewarded') {
                    await updateDoc(profileRef, { rewardedReportsAvailable: increment(-1) });
                }
                // 'premium' no necesita contador
                console.log(`Informe de tipo ${type} registrado.`);
            } catch (e) {
                console.error("Error al incrementar contador de informes:", e);
                showMessage("Error al registrar el informe. Inténtalo de nuevo.", "error");
            }
        }
        
        // --- Lógica de Modales (Planes y Pagos) ---

        function hideModals() {
            premiumModal.classList.add('hidden');
            premiumModal.classList.remove('visible');
            pagomovilModal.classList.add('hidden');
            pagomovilModal.classList.remove('visible');
            adLoadingModal.classList.add('hidden');
            adLoadingModal.classList.remove('visible');
        }

        function showPremiumModal() {
            hideModals();
            premiumModal.classList.remove('hidden');
            setTimeout(() => premiumModal.classList.add('visible'), 10);
            
            // Renderizar botones de PayPal
            renderPayPalButtons();
        }

        function showPagoMovilModal() {
            hideModals();
            pagomovilModal.classList.remove('hidden');
            setTimeout(() => pagomovilModal.classList.add('visible'), 10);
        }

        function showAdLoadingModal() {
            hideModals();
            adLoadingModal.classList.remove('hidden');
            setTimeout(() => adLoadingModal.classList.add('visible'), 10);
        }

        // --- Lógica de PayPal ---
        function renderPayPalButtons() {
            const container = document.getElementById('paypal-button-container');
            if (!container || container.children.length > 0) return; // No renderizar si ya existen

            paypal.Buttons({
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            description: "Plan Premium 1 Año - Informe de Aseguramiento",
                            amount: {
                                value: "15.00", // Monto en USD
                                currency_code: "USD"
                            }
                        }]
                    });
                },
                onApprove: async (data, actions) => {
                    try {
                        const details = await actions.order.capture();
                        console.log("Pago completado:", details);
                        await grantPremiumAccess();
                        showMessage("¡Pago completado! Ahora eres Premium.", "success");
                        hideModals();
                    } catch (err) {
                        console.error("Error en la aprobación de PayPal:", err);
                        showMessage("Error al procesar el pago.", "error");
                    }
                },
                onError: (err) => {
                    console.error("Error de PayPal:", err);
                    showMessage("Ocurrió un error con PayPal.", "error");
                }
            }).render('#paypal-button-container');
        }

        async function grantPremiumAccess() {
            const profileRef = getUserProfileRef();
            if (!profileRef) return;
            
            const expiryDate = new Date();
            expiryDate.setFullYear(expiryDate.getFullYear() + 1); // 1 año desde hoy
            
            try {
                await updateDoc(profileRef, {
                    plan: 'premium',
                    premiumUntil: Timestamp.fromDate(expiryDate),
                    reportsGenerated: 0 // Opcional: reiniciar contador
                });
            } catch (e) {
                console.error("Error al actualizar a premium:", e);
                showMessage("Pago recibido, pero hubo un error al activar tu cuenta. Contacta a soporte.", "error");
            }
        }

        // --- Lógica de Pago Móvil ---
        pagoMovilProofInput.addEventListener('change', () => {
            if (pagoMovilProofInput.files.length > 0) {
                submitPagoMovilBtn.disabled = false;
            } else {
                submitPagoMovilBtn.disabled = true;
            }
        });

        submitPagoMovilBtn.addEventListener('click', async () => {
            const file = pagoMovilProofInput.files[0];
            if (!file || !currentUserId) return;

            submitPagoMovilBtn.disabled = true;
            submitPagoMovilBtn.textContent = 'Subiendo...';

            try {
                // 1. Subir imagen a Storage
                const storagePath = `artifacts/${appId}/pagoMovilUploads/${currentUserId}/${Date.now()}-${file.name}`;
                const storageRef = ref(storage, storagePath);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                // 2. Crear registro de validación en Firestore (para el admin)
                const validationData = {
                    userId: currentUserId,
                    userEmail: auth.currentUser.email,
                    fileURL: downloadURL,
                    storagePath: storagePath,
                    status: 'pending', // El admin lo cambiará a 'approved' o 'rejected'
                    createdAt: serverTimestamp()
                };
                
                // Esta colección debe ser securizada para que solo admins puedan leer/escribir (excepto la creación)
                await addDoc(collection(db, `artifacts/${appId}/admin/pagoValidations`), validationData);

                showMessage("Comprobante enviado. Estará en revisión y se activará en 24h.", "success");
                hideModals();
                pagoMovilProofInput.value = '';

            } catch (e) {
                console.error("Error al subir pago móvil:", e);
                showMessage("Error al subir el comprobante. Inténtalo de nuevo.", "error");
            } finally {
                submitPagoMovilBtn.disabled = false;
                submitPagoMovilBtn.textContent = 'Subir y Notificar Pago';
            }
        });

        // --- Lógica de Anuncio Recompensado (Simulación) ---
        document.getElementById('rewardedAdBtn').addEventListener('click', () => {
            showAdLoadingModal();
            
            let timer = 5;
            const timerEl = document.getElementById('ad-timer');
            timerEl.textContent = timer;

            const interval = setInterval(async () => {
                timer--;
                timerEl.textContent = timer;
                if (timer <= 0) {
                    clearInterval(interval);
                    await grantRewardedReport();
                    hideModals();
                    showMessage("¡Has ganado 1 informe extra!", "success");
                }
            }, 1000);
        });

        async function grantRewardedReport() {
            const profileRef = getUserProfileRef();
            if (!profileRef) return;
            try {
                await updateDoc(profileRef, {
                    rewardedReportsAvailable: increment(1)
                });
            } catch (e) {
                console.error("Error al otorgar informe por anuncio:", e);
            }
        }

        // --- Aplicar Estilos de Botones ---
        function applyButtonStyles() {
            document.getElementById('addIncomeItemBtn').className = btnYellow; 
            document.querySelector('.btn-primary').className = btnPrimary;
            document.getElementById('saveContadorBtn').className = btnLilac; document.getElementById('saveClienteBtn').className = btnLilac;
            document.getElementById('clearFormBtn').className = `${btnYellow} flex items-center`; // Añadido flex
            document.getElementById('deleteContadorBtn').className = btnLilac + " gestion-btn"; document.getElementById('updateContadorBtn').className = btnLilac + " gestion-btn";
            document.getElementById('deleteClienteBtn').className = btnLilac + " gestion-btn"; document.getElementById('updateClienteBtn').className = btnLilac + " gestion-btn";
            document.getElementById('conceptoBtnAgregar').className = btnLilac; document.getElementById('conceptoBtnEditar').className = btnLilac;
            document.getElementById('conceptoBtnGuardarEdicion').className = `${btnLilac} hidden`; document.getElementById('conceptoBtnEliminar').className = btnLilac;
            document.getElementById('showPagoMovilBtn').className = "w-full py-2.5 px-4 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 transition-transform duration-150 ease-in-out active:scale-95";
            document.getElementById('rewardedAdBtn').className = "w-full py-2.5 px-4 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition-transform duration-150 ease-in-out active:scale-95";
        }
        applyButtonStyles();
        
        // --- Lógica de Formulario (Contadores, Clientes, Conceptos) ---
        // (El código de contadores, clientes y conceptos se mantiene igual que el original)
        // ... (código de gestión de contadores) ...
        // ... (código de gestión de clientes) ...
        // ... (código de gestión de conceptos) ...
        
        // (Listeners de la UI del formulario)
        contadorSelloInput.addEventListener('change', function() { const file = this.files[0]; if (file && file.type === "image/png") { const reader = new FileReader(); reader.onload = (e) => { selloPreview.src = e.target.result; selloPreview.classList.remove('hidden'); }; reader.readAsDataURL(file); } else { selloPreview.src = ''; selloPreview.classList.add('hidden'); if (file) { showMessage('Solo se permiten archivos PNG.', 'error'); this.value = ''; } } });

        function loadDropdowns() {
            if (!currentUserId) return;
            const contadoresPath = getCollectionPath('contadores');
            if (contadoresPath) {
                if (contadoresUnsubscribe) contadoresUnsubscribe();
                contadoresUnsubscribe = onSnapshot(query(collection(db, contadoresPath)), (snapshot) => {
                    const select = document.getElementById('selectContador'); const val = select.value; localContadores = []; select.innerHTML = '<option value="">-- Selecciona Contador --</option>';
                    snapshot.forEach((doc) => { const d = doc.data(); d.id = doc.id; localContadores.push(d); const opt = document.createElement('option'); opt.value = d.id; opt.textContent = `${d.nombre} (CPC: ${d.cpc})`; select.appendChild(opt); });
                    select.value = val; if (!val) { document.getElementById('deleteContadorBtn').style.display = 'none'; document.getElementById('updateContadorBtn').style.display = 'none'; }
                });
            }
            const clientesPath = getCollectionPath('clientes');
            if (clientesPath) {
                if (clientesUnsubscribe) clientesUnsubscribe();
                clientesUnsubscribe = onSnapshot(query(collection(db, clientesPath)), (snapshot) => {
                    const select = document.getElementById('selectCliente'); const val = select.value; localClientes = []; select.innerHTML = '<option value="">-- Selecciona Cliente --</option>';
                    snapshot.forEach((doc) => { const d = doc.data(); d.id = doc.id; localClientes.push(d); const opt = document.createElement('option'); opt.value = d.id; opt.textContent = `${d.nombre} (CI: ${d.cedula})`; select.appendChild(opt); });
                    select.value = val; if (!val) { document.getElementById('deleteClienteBtn').style.display = 'none'; document.getElementById('updateClienteBtn').style.display = 'none'; }
                });
            }
        }

        function fillContadorForm(id) { if (!id) { clearFormContador(false); return; } const d = localContadores.find(c => c.id === id); if (d) { document.getElementById('contadorNombre').value = d.nombre; document.getElementById('contadorRif').value = d.rif; document.getElementById('contadorCpc').value = d.cpc; document.getElementById('deleteContadorBtn').style.display = 'inline-block'; document.getElementById('updateContadorBtn').style.display = 'inline-block'; } }
        function fillClienteForm(id) { if (!id) { clearFormCliente(false); return; } const d = localClientes.find(c => c.id === id); if (d) { document.getElementById('clienteTratamiento').value = d.tratamiento; document.getElementById('clienteNombre').value = d.nombre; document.getElementById('clienteCedula').value = d.cedula; document.getElementById('deleteClienteBtn').style.display = 'inline-block'; document.getElementById('updateClienteBtn').style.display = 'inline-block'; } }

        async function saveContador() { const d = { nombre: document.getElementById('contadorNombre').value, rif: document.getElementById('contadorRif').value, cpc: document.getElementById('contadorCpc').value, createdAt: serverTimestamp() }; if (!d.nombre || !d.cpc) return showMessage('Complete nombre y C.P.C.', 'error'); if (localContadores.some(c => c.cpc === d.cpc)) return showMessage('CPC ya existe.', 'error'); try { await addDoc(collection(db, getCollectionPath('contadores')), d); showMessage('Contador guardado.', 'success'); clearFormContador(); } catch (e) { showMessage('Error al guardar.', 'error'); } }
        async function updateContador() { const id = document.getElementById('selectContador').value; if (!id) return; const d = { nombre: document.getElementById('contadorNombre').value, rif: document.getElementById('contadorRif').value, cpc: document.getElementById('contadorCpc').value, updatedAt: serverTimestamp() }; if (!d.nombre || !d.cpc) return; if (localContadores.some(c => c.cpc === d.cpc && c.id !== id)) return showMessage('CPC duplicado.', 'error'); try { await updateDoc(doc(db, getCollectionPath('contadores'), id), d); showMessage('Contador actualizado.', 'success'); } catch (e) { showMessage('Error al actualizar.', 'error'); } }
        async function deleteContador() { const id = document.getElementById('selectContador').value; if (id) showConfirmationModal('¿Eliminar contador?', async () => { try { await deleteDoc(doc(db, getCollectionPath('contadores'), id)); showMessage('Eliminado.', 'success'); clearFormContador(); } catch (e) { showMessage('Error al eliminar.', 'error'); } }); }

        async function saveCliente() { const d = { tratamiento: document.getElementById('clienteTratamiento').value, nombre: document.getElementById('clienteNombre').value, cedula: document.getElementById('clienteCedula').value, createdAt: serverTimestamp() }; if (!d.nombre || !d.cedula) return showMessage('Complete datos.', 'error'); if (localClientes.some(c => c.cedula === d.cedula)) return showMessage('Cédula ya existe.', 'error'); try { await addDoc(collection(db, getCollectionPath('clientes')), d); showMessage('Cliente guardado.', 'success'); clearFormCliente(); } catch (e) { showMessage('Error al guardar.', 'error'); } }
        async function updateCliente() { const id = document.getElementById('selectCliente').value; if (!id) return; const d = { tratamiento: document.getElementById('clienteTratamiento').value, nombre: document.getElementById('clienteNombre').value, cedula: document.getElementById('clienteCedula').value, updatedAt: serverTimestamp() }; if (!d.nombre || !d.cedula) return; if (localClientes.some(c => c.cedula === d.cedula && c.id !== id)) return showMessage('Cédula duplicada.', 'error'); try { await updateDoc(doc(db, getCollectionPath('clientes'), id), d); showMessage('Cliente actualizado.', 'success'); } catch (e) { showMessage('Error al actualizar.', 'error'); } }
        async function deleteCliente() { const id = document.getElementById('selectCliente').value; if (id) showConfirmationModal('¿Eliminar cliente?', async () => { try { await deleteDoc(doc(db, getCollectionPath('clientes'), id)); showMessage('Eliminado.', 'success'); clearFormCliente(); } catch (e) { showMessage('Error al eliminar.', 'error'); } }); }

        const DEFAULT_CONCEPTOS = ["Actividades Comerciales", "Alquiler de Inmueble", "Director de la Entidad", "Docente contratado tiempo completo", "Honorarios Profesionales de libre ejercicio", "Intereses generados por inversiones", "Servicios de Consultoría", "Servicios Técnicos", "Sueldos y Salarios"];
        async function inicializarConceptos() {
            if (!currentUserId) return;
            const path = getCollectionPath('conceptos'); if (!path) return;
            const defRef = doc(db, path, 'defaults_v6');
            try {
                const snap = await getDoc(defRef);
                if (!snap.exists()) {
                    const q = query(collection(db, path));
                    const existingSnap = await getDocs(q);
                    const existingNames = new Set();
                    existingSnap.forEach(doc => { if (doc.data().nombre) existingNames.add(doc.data().nombre.toLowerCase()); });
                    const batch = writeBatch(db); let addedCount = 0;
                    DEFAULT_CONCEPTOS.forEach(n => { if (!existingNames.has(n.toLowerCase())) { batch.set(doc(collection(db, path)), { nombre: n, createdAt: serverTimestamp(), isDefault: true }); addedCount++; } });
                    batch.set(defRef, { inicializado: true }); await batch.commit(); console.log(`Conceptos inicializados (v6). Agregados: ${addedCount}`);
                }
            } catch (e) { console.error("Error init conceptos:", e); }
            cargarConceptosUI();
        }
        function cargarConceptosUI() {
            const path = getCollectionPath('conceptos'); if (!path) return;
            if (conceptosUnsubscribe) conceptosUnsubscribe();
            conceptosUnsubscribe = onSnapshot(query(collection(db, path)), (snapshot) => {
                localConceptos = [];
                const select = document.getElementById('conceptosSelect'), datalist = document.getElementById('conceptos-list');
                select.innerHTML = '<option value="">-- Seleccionar para Editar/Eliminar --</option>'; datalist.innerHTML = ''; 
                snapshot.forEach(doc => { if (doc.id !== 'defaults_v6') { localConceptos.push({ id: doc.id, ...doc.data() }); } });
                localConceptos.sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
                localConceptos.forEach(c => { const optS = document.createElement('option'); optS.value = c.id; optS.textContent = c.nombre; select.appendChild(optS); const optD = document.createElement('option'); optD.value = c.nombre; datalist.appendChild(optD); });
                resetConceptoForm();
            }, (error) => { console.error("Error loading concepts:", error); showMessage('Error al cargar conceptos.', 'error'); });
        }
        function resetConceptoForm() { document.getElementById('conceptoEditInput').value = ''; edicionConceptoId = null; document.getElementById('conceptoBtnAgregar').classList.remove('hidden'); document.getElementById('conceptoBtnGuardarEdicion').classList.add('hidden'); document.getElementById('conceptoBtnCancelarEdicion').classList.add('hidden'); document.getElementById('conceptosSelect').value = ""; }
        document.getElementById('conceptoBtnAgregar').addEventListener('click', async () => { const val = document.getElementById('conceptoEditInput').value.trim(); if (val) { if (localConceptos.some(c => c.nombre.toLowerCase() === val.toLowerCase())) return showMessage('Concepto ya existe.', 'error'); try { await addDoc(collection(db, getCollectionPath('conceptos')), { nombre: val, createdAt: serverTimestamp(), isDefault: false }); showMessage('Concepto agregado.', 'success'); document.getElementById('conceptoEditInput').value = ''; } catch (e) { showMessage('Error al agregar.', 'error'); } } });
        document.getElementById('conceptoBtnEditar').addEventListener('click', () => { const id = document.getElementById('conceptosSelect').value; const c = localConceptos.find(x => x.id === id); if (c) { document.getElementById('conceptoEditInput').value = c.nombre; edicionConceptoId = id; document.getElementById('conceptoBtnAgregar').classList.add('hidden'); document.getElementById('conceptoBtnGuardarEdicion').classList.remove('hidden'); document.getElementById('conceptoBtnCancelarEdicion').classList.remove('hidden'); } else { showMessage('Seleccione un concepto para editar.', 'error'); } });
        document.getElementById('conceptoBtnCancelarEdicion').addEventListener('click', resetConceptoForm);
        document.getElementById('conceptoBtnGuardarEdicion').addEventListener('click', async () => { const val = document.getElementById('conceptoEditInput').value.trim(); if (val && edicionConceptoId) { if (localConceptos.some(c => c.nombre.toLowerCase() === val.toLowerCase() && c.id !== edicionConceptoId)) return showMessage('Nombre duplicado.', 'error'); try { await updateDoc(doc(db, getCollectionPath('conceptos'), edicionConceptoId), { nombre: val, updatedAt: serverTimestamp() }); showMessage('Concepto actualizado.', 'success'); resetConceptoForm(); } catch (e) { showMessage('Error al actualizar.', 'error'); } } });
        document.getElementById('conceptoBtnEliminar').addEventListener('click', () => { const id = document.getElementById('conceptosSelect').value; if (id) showConfirmationModal('¿Eliminar concepto?', async () => { try { await deleteDoc(doc(db, getCollectionPath('conceptos'), id)); showMessage('Eliminado.', 'success'); } catch (e) { showMessage('Error al eliminar.', 'error'); } }); else showMessage('Seleccione un concepto.', 'error'); });

        // --- Lógica de Formulario (Limpieza y Formato) ---
        function clearFormContador(sel = true) { document.getElementById('contadorNombre').value = ''; document.getElementById('contadorRif').value = ''; document.getElementById('contadorCpc').value = ''; contadorSelloInput.value = ''; selloPreview.classList.add('hidden'); if (sel) document.getElementById('selectContador').value = ""; document.getElementById('deleteContadorBtn').style.display = 'none'; document.getElementById('updateContadorBtn').style.display = 'none'; }
        function clearFormCliente(sel = true) { document.getElementById('clienteTratamiento').value = 'Sr.'; document.getElementById('clienteNombre').value = ''; document.getElementById('clienteCedula').value = ''; if (sel) document.getElementById('selectCliente').value = ""; document.getElementById('deleteClienteBtn').style.display = 'none'; document.getElementById('updateClienteBtn').style.display = 'none'; }
        function clearForm() { document.getElementById('report-form').reset(); document.getElementById('income-details').innerHTML = ''; addIncomeItem(); clearFormContador(); clearFormCliente(); setFechasDefault(); }
        document.getElementById('clearFormBtn').addEventListener('click', (e) => { e.preventDefault(); clearForm(); showMessage('Formulario limpiado.', 'success'); });
        function showConfirmationModal(msg, onConfirm) { const ov = document.createElement('div'); ov.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[101]'; ov.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full"><p class="mb-4 text-gray-800">${msg}</p><div class="flex justify-end gap-4"><button id="cfmCancel" class="py-2 px-4 bg-gray-200 rounded-full font-semibold">Cancelar</button><button id="cfmOk" class="py-2 px-4 bg-red-600 text-white rounded-full font-semibold">Eliminar</button></div></div>`; document.body.appendChild(ov); document.getElementById('cfmCancel').onclick = () => document.body.removeChild(ov); document.getElementById('cfmOk').onclick = () => { onConfirm(); document.body.removeChild(ov); }; }
        document.getElementById('clienteCedula').addEventListener('input', (e) => { let v = e.target.value.replace(/[^a-zA-Z0-9]/g, ''); let l = (v.match(/^[VEve]/) || ['V'])[0].toUpperCase(); let n = v.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, '').substring(0, 8); e.target.value = `${l}-${n.replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`; });
        document.getElementById('contadorRif').addEventListener('input', (e) => { let v = e.target.value.replace(/[^a-zA-Z0-9]/g, ''); let l = (v.match(/^[JGjgVEvePp]/) || ['V'])[0].toUpperCase(); let n = v.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, ''); let m = n.substring(0, 8), d = n.length > 8 ? n.substring(8, 9) : ''; e.target.value = `${l}-${m.replace(/\B(?=(\d{3})+(?!\d))/g, '.')}${d ? '-' + d : ''}`; });
        document.getElementById('contadorCpc').addEventListener('input', (e) => { let v = e.target.value.replace(/[^\d]/g, ''); e.target.value = v ? new Intl.NumberFormat('es-VE').format(parseInt(v, 10)) : ''; });
        function setFechasDefault() { const now = new Date(); document.getElementById('fechaDocumento').value = now.toISOString().split('T')[0]; document.getElementById('fechaDesde').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0]; document.getElementById('fechaHasta').value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]; }
        document.addEventListener('DOMContentLoaded', () => { if (!auth.currentUser) { addIncomeItem(); setFechasDefault(); } });
        document.getElementById('selectContador').addEventListener('change', (e) => fillContadorForm(e.target.value));
        document.getElementById('selectCliente').addEventListener('change', (e) => fillClienteForm(e.target.value));
        document.getElementById('saveContadorBtn').addEventListener('click', saveContador); document.getElementById('updateContadorBtn').addEventListener('click', updateContador); document.getElementById('deleteContadorBtn').addEventListener('click', deleteContador);
        document.getElementById('saveClienteBtn').addEventListener('click', saveCliente); document.getElementById('updateClienteBtn').addEventListener('click', updateCliente); document.getElementById('deleteClienteBtn').addEventListener('click', deleteCliente);
        document.getElementById('showPagoMovilBtn').addEventListener('click', showPagoMovilModal);
        
        // --- Lógica de Ingresos (Items) ---
        window.addIncomeItem = function() {
            const c = document.getElementById('income-details');
            const d = document.createElement('div'); d.className = 'flex flex-col md:flex-row items-center gap-3 income-item';
            d.innerHTML = `<input type="text" placeholder="Concepto" class="w-full md:flex-grow p-2 border border-gray-300 rounded-md income-concept" list="conceptos-list" required><input type="text" inputmode="decimal" placeholder="Monto (Bs.)" class="w-full md:w-32 p-2 border border-gray-300 rounded-md income-amount" required><button type="button" class="p-2.5 bg-red-100 text-red-600 hover:bg-red-200 rounded-full btn-remove-income flex-shrink-0 transition-colors duration-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>`;
            d.querySelector('.income-amount').addEventListener('input', formatCurrencyInput);
            d.querySelector('.btn-remove-income').onclick = () => c.querySelectorAll('.income-item').length > 1 ? c.removeChild(d) : showMessage('Debe haber al menos un concepto.', 'error');
            c.appendChild(d);
        };
        document.getElementById('addIncomeItemBtn').addEventListener('click', addIncomeItem);
        function formatCurrencyInput(e) { let v = e.target.value.replace(/[^\d,]/g, ''), p = v.split(','); let i = p[0].replace(/\./g, ''); i = i ? new Intl.NumberFormat('es-VE').format(parseInt(i, 10)) : (p.length > 1 ? '0' : ''); e.target.value = i + (p[1] !== undefined ? ',' + p[1].substring(0, 2) : ''); }
        
        // --- Lógica de Generación de PDF ---
        function parseVal(s) { return parseFloat((s || '0').replace(/\./g, '').replace(',', '.')) || 0; }
        function fmtDate(s, long = false) { if (!s) return ''; const d = s instanceof Date ? s : new Date(s + 'T00:00:00'); if (long) return `${d.getDate()} de ${["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"][d.getMonth()]} ${d.getFullYear()}`; return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; }
        function fmtCur(n) { return new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n); }

        // Mover buildPDF fuera del listener
        function buildPDF(sealData, sealW, sealH) {
            try {
                const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'pt', 'letter');
                const margin = 60, pageH = doc.internal.pageSize.getHeight(), usableW = doc.internal.pageSize.getWidth() - 120;
                let y = 141.75; // 5cm top margin

                const getVal = (id) => document.getElementById(id).value;
                const cNom = getVal('contadorNombre'), cCpc = getVal('contadorCpc'), cRif = getVal('contadorRif');
                const clTrat = getVal('clienteTratamiento'), clNom = getVal('clienteNombre'), clCed = getVal('clienteCedula');
                const fDoc = getVal('fechaDocumento'), fDes = getVal('fechaDesde'), fHas = getVal('fechaHasta');

                let total = 0, data = [];
                document.querySelectorAll('.income-item').forEach(i => { const m = parseVal(i.querySelector('.income-amount').value); if (m > 0) { data.push([i.querySelector('.income-concept').value, `Bs. ${fmtCur(m)}`]); total += m; } });

                const addTxt = (txt, opts = {}) => {
                    doc.setFontSize(opts.fontSize || 11); doc.setFont('helvetica', opts.fontStyle || 'normal');
                    const lines = doc.splitTextToSize(txt, usableW - (opts.indent || 0));
                    const h = (lines.length * (opts.fontSize || 11) * (opts.lineSpacing || 1.5)) - ((opts.fontSize || 11) * ((opts.lineSpacing || 1.5) - 1));
                    if (y + h > pageH - 70.86) { doc.addPage(); y = 141.75; }
                    doc.text(txt, opts.align === 'center' ? doc.internal.pageSize.getWidth() / 2 : (opts.align === 'right' ? doc.internal.pageSize.getWidth() - 60 : 60 + (opts.indent || 0)), y, { align: opts.align || 'justify', maxWidth: usableW - (opts.indent || 0), lineHeightFactor: opts.lineSpacing || 1.5 });
                    y += h + (opts.spacing || 15);
                };

                // --- PÁGINAS PDF (Idéntico al original) ---
                addTxt('INFORME DE ENCARGOS DE ASEGURAMIENTO DEL CONTADOR PÚBLICO INDEPENDIENTE', { fontStyle: 'bold', align: 'center', spacing: 30 });
                addTxt('Alcance', { fontStyle: 'bold', spacing: 20 });
                addTxt(`He revisado la evidencia inherente a los ingresos percibidos por el ${clTrat} ${clNom}, con cedula de identidad N.º ${clCed}, durante el periodo comprendido desde el ${fmtDate(fDes)} hasta el ${fmtDate(fHas)}, presentado en la relación de ingresos adjunta, correspondiente a su actividad económica según se detalla en el anexo.`, { indent: 20, spacing: 25 });
                addTxt('Responsabilidad de la persona que percibe los ingresos', { fontStyle: 'bold', spacing: 20 });
                addTxt(`El ${clTrat} ${clNom}, es responsable de la preparación y presentación del importe de sus ingresos que se adjunta en este informe, incluyendo la integridad, legalidad y veracidad de los documentos suministrados. Esta responsabilidad incluye la aseveración de que todos y cada uno de los ingresos detallados en la relación, provienen de actividades legítimas y de comprobable licito ejercicio.`, { indent: 20, spacing: 25 });
                addTxt('Responsabilidad del Contador Público Independiente', { fontStyle: 'bold', spacing: 20 });
                const respP1 = `Mi responsabilidad es expresar una opinión sobre la relación de ingresos obtenida por el ${clTrat} ${clNom}, durante el periodo señalado de acuerdo con mis procedimientos, los cuales he realizado de conformidad con la Norma Internacional para encargos de aseguramiento, los cuales he realizado de conformidad con la Normas Internacionales de Encargos de Aseguramiento NIEA 3000, esta norma prevé que cumpla con los requerimientos éticos y que planifique y realice los procedimientos para obtener una seguridad razonable de que, en todos los aspectos materiales, la relación está presentada razonablemente.`;
                const respP2 = `Un Encargo de Aseguramiento implica llevar a cabo procedimientos para obtener evidencia acerca de la razonabilidad de las aseveraciones emitidas por el responsable. Los procedimientos seleccionados dependen del juicio profesional del contador público, que incluye evaluar los riesgos acerca de que los ingresos no estén presentados razonablemente. El objetivo es obtener una seguridad razonable como base de una forma positiva de expresión. Por lo tanto, mi responsabilidad es expresar una opinión sobre los ingresos del ${clTrat} ${clNom}, para el periodo ${fmtDate(fDes)} hasta el ${fmtDate(fHas)}, con base al examen sobre la evidencia obtenida.`;
                addTxt(`${respP1}\n\n${respP2}`, { indent: 20, spacing: 25 });
                doc.addPage(); y = 141.75;
                addTxt('Identificación del criterio de evaluación', { fontStyle: 'bold', spacing: 20 });
                addTxt(`Mi trabajo consistió, en examinar los estados de cuenta de bancos, declaraciones de impuesto, contratos, entre otros documentos inherentes, comprobar y confirmar los ingresos relacionados por el ${clTrat} ${clNom}, para el periodo señalado. Mi opinión se formó sobre la base de la evidencia obtenida suficiente y adecuada. El criterio utilizado para emitirla fue la definición de ingresos contenida en la sección 2, conceptos y principios generales, de las normas internacionales de información financiera para las pequeñas y medianas entidades aun cuando no le son aplicables a personas naturales no comerciantes.`, { indent: 20, spacing: 25 });
                addTxt('Opinión', { fontStyle: 'bold', spacing: 20 });
                addTxt('Con base en el trabajo efectuado descrito en este informe, no ha llamado mi atención algo que me haga pensar que la relación de ingresos que se anexa, en todos los aspectos importantes, no sea razonable y que los ingresos detallados en la relación, no provenga de actividades legítimas y de comprobable lícito ejercicio.', { indent: 20, spacing: 25 });
                addTxt('Usuarios Previstos y Propósitos', { fontStyle: 'bold', spacing: 20 });
                addTxt(`Este informe y la relación que se adjunta están dirigidos únicamente al ${getVal('entidadDirigida')} el cual lo ha requerido para ${getVal('motivoInforme')}.`, { indent: 20, spacing: 40 });
                const sigH = (4 * 11 * 1) + (cRif ? 12 : 0);
                let sigY = pageH - 85 - sigH; 
                if (sealData) { const ratio = Math.min((5.3 * 28.35) / sealW, (2.1 * 28.35) / sealH); const sW = Math.min(sealW * ratio, sealW * 0.75), sH = Math.min(sealH * ratio, sealH * 0.75); doc.addImage(sealData, 'PNG', doc.internal.pageSize.getWidth() - 60 - sW, sigY - sH - 6, sW, sH); }
                y = sigY;
                addTxt('________________________________', { align: 'center', spacing: 12, lineSpacing: 1 });
                addTxt(cNom, { align: 'center', spacing: 12, fontStyle: 'bold', lineSpacing: 1 });
                addTxt(`Contador Público C.P.C. N ${cCpc}`, { align: 'center', spacing: 12, lineSpacing: 1 });
                if (cRif) addTxt(`Rif: ${cRif}`, { align: 'center', spacing: 12, lineSpacing: 1 });
                y = pageH - 50; 
                addTxt(`${getVal('lugar')}, ${fmtDate(fDoc, true)}`, { align: 'left', spacing: 0, lineSpacing: 1.5 });
                doc.addPage(); y = 141.75;
                addTxt(clNom.toUpperCase(), { fontStyle: 'bold', align: 'center', spacing: 10 });
                addTxt(clCed, { fontStyle: 'bold', align: 'center', spacing: 30 });
                addTxt('INGRESOS MENSUALES EXPRESADO EN BOLÍVARES (BS)', { fontStyle: 'bold', align: 'center', spacing: 20 });
                addTxt(`Los ingresos corresponden al período desde el ${fmtDate(fDes, true)} hasta el ${fmtDate(fHas, true)} y los mismos se derivan de:`, { spacing: 30 });
                doc.autoTable({ head: [['Detalle de los ingresos del periodo:', 'Bolívares']], body: data, foot: [[{ content: 'Total Ingresos', styles: { halign: 'left' } }, { content: `Bs. ${fmtCur(total)}`, styles: { halign: 'right' } }]], startY: y, margin: { left: 60, right: 60, top: 141.75, bottom: 70.86 }, theme: 'grid', headStyles: { fillColor: [221, 214, 254], textColor: [31, 41, 55], fontStyle: 'bold', halign: 'center' }, footStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0], fontStyle: 'bold' }, columnStyles: { 1: { halign: 'right' } }, didDrawPage: (d) => y = d.cursor.y > 141.75 ? d.cursor.y : 141.75 });
                y = doc.autoTable.previous.finalY + 30;
                const clSigH = 100; if (y + clSigH > pageH - 70.86) { doc.addPage(); y = 141.75; }
                addTxt('LEGITIMACION DE CAPITALES', { fontStyle: 'bold', align: 'center', spacing: 15 });
                addTxt('Los ingresos descritos en la presente relación proceden de actividad lícita, lo cual puede ser corroborado por los organismos competentes y no tienen relación alguna con actividades, acciones o hechos ilícitos contemplados en las leyes venezolanas.', { spacing: 50 });
                y = Math.max(y, pageH - 70.86 - 60);
                addTxt('_____________________________________', { align: 'center', spacing: 12, lineSpacing: 1 });
                addTxt(clNom, { align: 'center', spacing: 12, fontStyle: 'bold', lineSpacing: 1 });
                addTxt(clCed, { align: 'center', spacing: 12, fontStyle: 'bold', lineSpacing: 1 });
                const safeClientName = clNom.replace(/[^a-zA-Z0-9]/g, '_');
                doc.save(`Informe_Aseguramiento_${safeClientName}.pdf`);

            } catch (error) {
                console.error('Error al generar el PDF:', error);
                showMessage('Error al generar el PDF: ' + error.message, 'error');
            }
        }
        
        // --- Listener del Formulario Principal (MODIFICADO) ---
        document.getElementById('report-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. Validar campos de ingresos
            const items = document.querySelectorAll('.income-item');
            if ([...items].some(i => !i.querySelector('.income-concept').value || parseVal(i.querySelector('.income-amount').value) <= 0)) {
                return showMessage('Revise conceptos y montos. Deben tener un valor válido.', 'error');
            }

            // 2. Verificar permiso de generación
            const check = canGenerateReport();
            
            if (check.allow) {
                // 3. Si se permite, registrar el informe
                await incrementReportCount(check.type);
                
                // 4. Proceder a generar el PDF
                const file = contadorSelloInput.files[0];
                if (file && file.type === "image/png") {
                    const r = new FileReader(); 
                    r.onload = (e) => { 
                        const img = new Image(); 
                        img.onload = function() { buildPDF(e.target.result, this.width, this.height); }; 
                        img.src = e.target.result; 
                    }; 
                    r.readAsDataURL(file);
                } else {
                    buildPDF(null, 0, 0);
                }
                
                // Mostrar un mensaje de éxito
                if (check.type === 'free') {
                    showMessage(`Informe generado. Te quedan ${2 - userPlanStatus.reportsGenerated} informes gratuitos.`, 'success');
                } else if (check.type === 'rewarded') {
                    showMessage(`Informe generado usando un informe extra. Te quedan ${userPlanStatus.rewardedReportsAvailable - 1}.`, 'success');
                } else {
                    showMessage("Informe Premium generado.", "success");
                }

            } else if (check.reason === 'limit_reached') {
                // 5. Si no se permite, mostrar modal de pago
                showPremiumModal();
            } else {
                // Otro error (ej. no autenticado)
                showMessage('Debes iniciar sesión para generar informes.', 'error');
            }
        });

    </script>
</body>
</html>
